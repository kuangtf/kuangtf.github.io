<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Spring IoC å®¹å™¨æºç åˆ†æ, å¸…æ«">
    <meta name="description" content="æœç€æˆåŠŸå‰è¿›">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Spring IoC å®¹å™¨æºç åˆ†æ | å¸…æ«</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="å¸…æ«" type="application/atom+xml">
</head>



   <style>
    body{
       background-image: url(/medias/back.png);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">å¸…æ«</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">å¸…æ«</div>
        <div class="logo-desc">
            
            æœç€æˆåŠŸå‰è¿›
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/kuangtf" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/kuangtf" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Spring IoC å®¹å™¨æºç åˆ†æ</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Spring-IoC/">
                                <span class="chip bg-color">Spring IoC</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Spring/" class="post-category">
                                Spring
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2022-05-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>æ›´æ–°æ—¥æœŸ:&nbsp;&nbsp;
                    2022-02-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>æ–‡ç« å­—æ•°:&nbsp;&nbsp;
                    19k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>é˜…è¯»æ—¶é•¿:&nbsp;&nbsp;
                    82 åˆ†
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>é˜…è¯»æ¬¡æ•°:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- æ˜¯å¦åŠ è½½ä½¿ç”¨è‡ªå¸¦çš„ prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="ğŸš‡-Spring-IoC-å®¹å™¨æºç åˆ†æ"><a href="#ğŸš‡-Spring-IoC-å®¹å™¨æºç åˆ†æ" class="headerlink" title="ğŸš‡ Spring IoC å®¹å™¨æºç åˆ†æ"></a>ğŸš‡ Spring IoC å®¹å™¨æºç åˆ†æ</h1><p>Spring æœ€é‡è¦çš„æ¦‚å¿µæ˜¯ IOC å’Œ AOPï¼Œæœ¬ç¯‡æ–‡ç« å…¶å®å°±æ˜¯è¦å¸¦é¢†å¤§å®¶æ¥åˆ†æä¸‹ Spring çš„ IOC å®¹å™¨ã€‚æ—¢ç„¶å¤§å®¶å¹³æ—¶éƒ½è¦ç”¨åˆ° Springï¼Œæ€ä¹ˆå¯ä»¥ä¸å¥½å¥½äº†è§£ Spring å‘¢ï¼Ÿé˜…è¯»æœ¬æ–‡å¹¶ä¸èƒ½è®©ä½ æˆä¸º Spring ä¸“å®¶ï¼Œä¸è¿‡ä¸€å®šæœ‰åŠ©äºå¤§å®¶ç†è§£ Spring çš„å¾ˆå¤šæ¦‚å¿µï¼Œå¸®åŠ©å¤§å®¶æ’æŸ¥åº”ç”¨ä¸­å’Œ Spring ç›¸å…³çš„ä¸€äº›é—®é¢˜ã€‚</p>
<p>æœ¬æ–‡é‡‡ç”¨çš„æºç ç‰ˆæœ¬æ˜¯ 4.3.11.RELEASEï¼Œç®—æ˜¯ 5.0.x å‰æ¯”è¾ƒæ–°çš„ç‰ˆæœ¬äº†ã€‚ä¸ºäº†é™ä½éš¾åº¦ï¼Œæœ¬æ–‡æ‰€è¯´çš„æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯åŸºäº xml çš„é…ç½®çš„æ–¹å¼ï¼Œå®é™…ä½¿ç”¨å·²ç»å¾ˆå°‘äººè¿™ä¹ˆåšäº†ï¼Œè‡³å°‘ä¸æ˜¯çº¯ xml é…ç½®ï¼Œä¸è¿‡ä»ç†è§£æºç çš„è§’åº¦æ¥çœ‹ç”¨è¿™ç§æ–¹å¼æ¥è¯´æ— ç–‘æ˜¯æœ€åˆé€‚çš„ã€‚</p>
<p>é˜…è¯»å»ºè®®ï¼šè¯»è€…è‡³å°‘éœ€è¦çŸ¥é“æ€ä¹ˆé…ç½® Springï¼Œäº†è§£ Spring ä¸­çš„å„ç§æ¦‚å¿µï¼Œå°‘éƒ¨åˆ†å†…å®¹æˆ‘è¿˜å‡è®¾è¯»è€…ä½¿ç”¨è¿‡ SpringMVCã€‚æœ¬æ–‡è¦è¯´çš„ IOC æ€»ä½“æ¥è¯´æœ‰ä¸¤å¤„åœ°æ–¹æœ€é‡è¦ï¼Œä¸€ä¸ªæ˜¯åˆ›å»º Bean å®¹å™¨ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ– Beanï¼Œå¦‚æœè¯»è€…è§‰å¾—ä¸€æ¬¡æ€§çœ‹å®Œæœ¬æ–‡å‹åŠ›æœ‰ç‚¹å¤§ï¼Œé‚£ä¹ˆå¯ä»¥æŒ‰è¿™ä¸ªæ€è·¯åˆ†ä¸¤æ¬¡æ¶ˆåŒ–ã€‚è¯»è€…ä¸ä¸€å®šå¯¹ Spring å®¹å™¨çš„æºç æ„Ÿå…´è¶£ï¼Œä¹Ÿè®¸é™„å½•éƒ¨åˆ†ä»‹ç»çš„çŸ¥è¯†å¯¹è¯»è€…æœ‰äº›è®¸ä½œç”¨ã€‚</p>
<p>å¸Œæœ›é€šè¿‡æœ¬æ–‡å¯ä»¥è®©è¯»è€…ä¸æƒ§æ€•é˜…è¯» Spring æºç ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶èƒ½åé¦ˆè¡¨è¿°é”™è¯¯æˆ–ä¸åˆç†çš„åœ°æ–¹ã€‚</p>
<h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1. å¼•è¨€"></a>1. å¼•è¨€</h2><p>å…ˆçœ‹ä¸‹æœ€åŸºæœ¬çš„å¯åŠ¨ Spring å®¹å™¨çš„ä¾‹å­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"classpath:applicationfile.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ä»¥ä¸Šä»£ç å°±å¯ä»¥åˆ©ç”¨é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª Spring å®¹å™¨äº†ï¼Œè¯·ä½¿ç”¨ maven çš„å°ä¼™ä¼´ç›´æ¥åœ¨ dependencies ä¸­åŠ ä¸Šä»¥ä¸‹ä¾èµ–å³å¯ï¼Œä¸ªäººæ¯”è¾ƒåå¯¹é‚£äº›ä¸çŸ¥é“è¦æ·»åŠ ä»€ä¹ˆä¾èµ–ï¼Œç„¶åæŠŠ Spring çš„æ‰€æœ‰ç›¸å…³çš„ä¸œè¥¿éƒ½åŠ è¿›æ¥çš„æ–¹å¼ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
  <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>context<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
  <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.3</span><span class="token number">.11</span><span class="token punctuation">.</span>RELEASE<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>spring-context ä¼šè‡ªåŠ¨å°† spring-coreã€spring-beansã€spring-aopã€spring-expression è¿™å‡ ä¸ªåŸºç¡€ jar åŒ…å¸¦è¿›æ¥ã€‚</p>
</blockquote>
<p>å¤šè¯´ä¸€å¥ï¼Œå¾ˆå¤šå¼€å‘è€…å…¥é—¨å°±ç›´æ¥æ¥è§¦çš„ SpringMVCï¼Œå¯¹ Spring å…¶å®ä¸æ˜¯å¾ˆäº†è§£ï¼ŒSpring æ˜¯æ¸è¿›å¼çš„å·¥å…·ï¼Œå¹¶ä¸å…·æœ‰å¾ˆå¼ºçš„ä¾µå…¥æ€§ï¼Œå®ƒçš„æ¨¡å—ä¹Ÿåˆ’åˆ†å¾—å¾ˆåˆç†ï¼Œå³ä½¿ä½ çš„åº”ç”¨ä¸æ˜¯ web åº”ç”¨ï¼Œæˆ–è€…ä¹‹å‰å®Œå…¨æ²¡æœ‰ä½¿ç”¨åˆ° Springï¼Œè€Œä½ å°±æƒ³ç”¨ Spring çš„ä¾èµ–æ³¨å…¥è¿™ä¸ªåŠŸèƒ½ï¼Œå…¶å®å®Œå…¨æ˜¯å¯ä»¥çš„ï¼Œå®ƒçš„å¼•å…¥ä¸ä¼šå¯¹å…¶ä»–çš„ç»„ä»¶äº§ç”Ÿå†²çªã€‚</p>
<p>åºŸè¯è¯´å®Œï¼Œæˆ‘ä»¬ç»§ç»­ã€‚<code>ApplicationContext context = new ClassPathXmlApplicationContext(...)</code> å…¶å®å¾ˆå¥½ç†è§£ï¼Œä»åå­—ä¸Šå°±å¯ä»¥çŒœå‡ºä¸€äºŒï¼Œå°±æ˜¯åœ¨ ClassPath ä¸­å¯»æ‰¾ xml é…ç½®æ–‡ä»¶ï¼Œæ ¹æ® xml æ–‡ä»¶å†…å®¹æ¥æ„å»º ApplicationContextã€‚å½“ç„¶ï¼Œé™¤äº† ClassPathXmlApplicationContext ä»¥å¤–ï¼Œæˆ‘ä»¬ä¹Ÿè¿˜æœ‰å…¶ä»–æ„å»º ApplicationContext çš„æ–¹æ¡ˆå¯ä¾›é€‰æ‹©ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¤§ä½“çš„ç»§æ‰¿ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ï¼š</p>
<p><img src="https://www.javadoop.com/blogimages/spring-context/1.png" alt="1"></p>
<blockquote>
<p>è¯»è€…å¯ä»¥å¤§è‡´çœ‹ä¸€ä¸‹ç±»åï¼Œæºç åˆ†æçš„æ—¶å€™ä¸è‡³äºæ‰¾ä¸ç€çœ‹å“ªä¸ªç±»ï¼Œå› ä¸º Spring ä¸ºäº†é€‚åº”å„ç§ä½¿ç”¨åœºæ™¯ï¼Œæä¾›çš„å„ä¸ªæ¥å£éƒ½å¯èƒ½æœ‰å¾ˆå¤šçš„å®ç°ç±»ã€‚å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œå°±æ˜¯æªç€ä¸€ä¸ªå®Œæ•´çš„åˆ†æ”¯çœ‹å®Œã€‚</p>
<p>å½“ç„¶ï¼Œè¯»æœ¬æ–‡çš„æ—¶å€™è¯»è€…ä¹Ÿä¸å¿…å¤ªæ‹…å¿ƒï¼Œæ¯ä¸ªä»£ç å—åˆ†æçš„æ—¶å€™ï¼Œæˆ‘éƒ½ä¼šå‘Šè¯‰è¯»è€…æˆ‘ä»¬åœ¨è¯´å“ªä¸ªç±»ç¬¬å‡ è¡Œã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒClassPathXmlApplicationContext å…œå…œè½¬è½¬äº†å¥½ä¹…æ‰åˆ° ApplicationContext æ¥å£ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç»¿é¢œè‰²çš„ <strong>FileSystemXmlApplicationContext</strong> å’Œ <strong>AnnotationConfigApplicationContext</strong> è¿™ä¸¤ä¸ªç±»ã€‚</p>
<p><strong>1ã€FileSystemXmlApplicationContext</strong> çš„æ„é€ å‡½æ•°éœ€è¦ä¸€ä¸ª xml é…ç½®æ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œå…¶ä»–å’Œ ClassPathXmlApplicationContext åŸºæœ¬ä¸Šä¸€æ ·ã€‚</p>
<p><strong>2ã€AnnotationConfigApplicationContext</strong> æ˜¯åŸºäºæ³¨è§£æ¥ä½¿ç”¨çš„ï¼Œå®ƒä¸éœ€è¦é…ç½®æ–‡ä»¶ï¼Œé‡‡ç”¨ java é…ç½®ç±»å’Œå„ç§æ³¨è§£æ¥é…ç½®ï¼Œæ˜¯æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼Œä¹Ÿæ˜¯å¤§åŠ¿æ‰€è¶‹å§ã€‚</p>
<p>ä¸è¿‡æœ¬æ–‡æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£æ•´ä¸ªæ„å»ºæµç¨‹ï¼Œæ‰€ä»¥å†³å®šä½¿ç”¨ ClassPathXmlApplicationContext è¿›è¡Œåˆ†æã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹çœ‹æ€ä¹ˆå®ä¾‹åŒ– ApplicationContextã€‚</p>
<p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å®šä¹‰æ¥å£å®ç°ç±»ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"hello world"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <strong>resources</strong> ç›®å½•æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åéšæ„ï¼Œé€šå¸¸å« application.xml æˆ– application-xxx.xml å°±å¯ä»¥äº†ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">"</span></span> <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messageService<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·‘èµ·æ¥äº†ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ä¸€ä¸ª ApplicationContext</span>
        <span class="token class-name">ApplicationContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">"classpath:application.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"context å¯åŠ¨æˆåŠŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token comment">// ä» context ä¸­å–å‡ºæˆ‘ä»¬çš„ Beanï¼Œè€Œä¸æ˜¯ç”¨ new MessageServiceImpl() è¿™ç§æ–¹å¼</span>
        <span class="token class-name">MessageService</span> messageService <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MessageService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™å¥å°†è¾“å‡º: hello world</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messageService<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»¥ä¸Šä¾‹å­å¾ˆç®€å•ï¼Œä¸è¿‡ä¹Ÿå¤Ÿå¼•å‡ºæœ¬æ–‡çš„ä¸»é¢˜äº†ï¼Œå°±æ˜¯æ€ä¹ˆæ ·é€šè¿‡é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ Spring çš„ ApplicationContext ï¼Ÿä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ IOC çš„æ ¸å¿ƒäº†ã€‚ApplicationContext å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¼šè´Ÿè´£åˆ›å»ºå®ä¾‹ Beanï¼Œå¾€å„ä¸ª Bean ä¸­æ³¨å…¥ä¾èµ–ç­‰ã€‚</p>
<h2 id="2-BeanFactory-ç®€ä»‹"><a href="#2-BeanFactory-ç®€ä»‹" class="headerlink" title="2. BeanFactory ç®€ä»‹"></a>2. BeanFactory ç®€ä»‹</h2><p>BeanFactoryï¼Œä»åå­—ä¸Šä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç”Ÿäº§ bean çš„å·¥å‚ï¼Œå®ƒè´Ÿè´£ç”Ÿäº§å’Œç®¡ç†å„ä¸ª bean å®ä¾‹ã€‚</p>
<p>åˆå­¦è€…å¯åˆ«ä»¥ä¸ºæˆ‘ä¹‹å‰è¯´é‚£ä¹ˆå¤šå’Œ BeanFactory æ— å…³ï¼Œå‰é¢è¯´çš„ ApplicationContext å…¶å®å°±æ˜¯ä¸€ä¸ª BeanFactoryã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å’Œ BeanFactory æ¥å£ç›¸å…³çš„ä¸»è¦çš„ç»§æ‰¿ç»“æ„ï¼š</p>
<p><img src="https://www.javadoop.com/blogimages/spring-context/2.png" alt="2"></p>
<p>æˆ‘æƒ³ï¼Œå¤§å®¶çœ‹å®Œè¿™ä¸ªå›¾ä»¥åï¼Œå¯èƒ½å°±ä¸æ˜¯å¾ˆå¼€å¿ƒäº†ã€‚ApplicationContext å¾€ä¸‹çš„ç»§æ‰¿ç»“æ„å‰é¢ä¸€å¼ å›¾è¯´è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚è¿™å¼ å›¾å‘¢ï¼ŒèƒŒä¸‹æ¥è‚¯å®šæ˜¯ä¸éœ€è¦çš„ï¼Œæœ‰å‡ ä¸ªé‡ç‚¹å’Œå¤§å®¶è¯´æ˜ä¸‹å°±å¥½ã€‚</p>
<ol>
<li>ApplicationContext ç»§æ‰¿äº† ListableBeanFactoryï¼Œè¿™ä¸ª Listable çš„æ„æ€å°±æ˜¯ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å¤šä¸ª Beanï¼Œå¤§å®¶çœ‹æºç ä¼šå‘ç°ï¼Œæœ€é¡¶å±‚ BeanFactory æ¥å£çš„æ–¹æ³•éƒ½æ˜¯è·å–å•ä¸ª Bean çš„ã€‚</li>
<li>ApplicationContext ç»§æ‰¿äº† HierarchicalBeanFactoryï¼ŒHierarchical å•è¯æœ¬èº«å·²ç»èƒ½è¯´æ˜é—®é¢˜äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åœ¨åº”ç”¨ä¸­èµ·å¤šä¸ª BeanFactoryï¼Œç„¶åå¯ä»¥å°†å„ä¸ª BeanFactory è®¾ç½®ä¸ºçˆ¶å­å…³ç³»ã€‚</li>
<li>AutowireCapableBeanFactory è¿™ä¸ªåå­—ä¸­çš„ Autowire å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰ï¼Œå®ƒå°±æ˜¯ç”¨æ¥è‡ªåŠ¨è£…é… Bean ç”¨çš„ï¼Œä½†æ˜¯ä»”ç»†çœ‹ä¸Šå›¾ï¼ŒApplicationContext å¹¶æ²¡æœ‰ç»§æ‰¿å®ƒï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œä¸ä½¿ç”¨ç»§æ‰¿ï¼Œä¸ä»£è¡¨ä¸å¯ä»¥ä½¿ç”¨ç»„åˆï¼Œå¦‚æœä½ çœ‹åˆ° ApplicationContext æ¥å£å®šä¹‰ä¸­çš„æœ€åä¸€ä¸ªæ–¹æ³• getAutowireCapableBeanFactory() å°±çŸ¥é“äº†ã€‚</li>
<li>ConfigurableListableBeanFactory ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ¥å£ï¼Œçœ‹å›¾ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒç»§æ‰¿äº†ç¬¬äºŒå±‚æ‰€æœ‰çš„ä¸‰ä¸ªæ¥å£ï¼Œè€Œ ApplicationContext æ²¡æœ‰ã€‚è¿™ç‚¹ä¹‹åä¼šç”¨åˆ°ã€‚</li>
<li>è¯·å…ˆä¸ç”¨èŠ±æ—¶é—´åœ¨å…¶ä»–çš„æ¥å£å’Œç±»ä¸Šï¼Œå…ˆç†è§£æˆ‘è¯´çš„è¿™å‡ ç‚¹å°±å¯ä»¥äº†ã€‚</li>
</ol>
<p>ç„¶åï¼Œè¯·è¯»è€…æ‰“å¼€ç¼–è¾‘å™¨ï¼Œç¿»ä¸€ä¸‹ BeanFactoryã€ListableBeanFactoryã€HierarchicalBeanFactoryã€AutowireCapableBeanFactoryã€ApplicationContext è¿™å‡ ä¸ªæ¥å£çš„ä»£ç ï¼Œå¤§æ¦‚çœ‹ä¸€ä¸‹å„ä¸ªæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå¤§å®¶å¿ƒé‡Œè¦æœ‰åº•ï¼Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´ä»£ç ä»‹ç»äº†ã€‚</p>
<h2 id="3-å¯åŠ¨è¿‡ç¨‹åˆ†æ"><a href="#3-å¯åŠ¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="3. å¯åŠ¨è¿‡ç¨‹åˆ†æ"></a>3. å¯åŠ¨è¿‡ç¨‹åˆ†æ</h2><p>æ€»çš„æ¥è¯´ï¼ŒSpring IoC çš„å¯åŠ¨è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<img src="https://gitee.com/veal98/images/raw/master/img/20201221100608.png" style="zoom:50%;">

<p>ä¸‹é¢å°†ä¼šæ˜¯å†—é•¿çš„ä»£ç åˆ†æï¼Œè®°ä½ï¼Œä¸€å®šè¦è‡ªå·±æ‰“å¼€æºç æ¥çœ‹ï¼Œä¸ç„¶çº¯çœ‹æ˜¯å¾ˆç´¯çš„ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬è‚¯å®šè¦ä» ClassPathXmlApplicationContext çš„æ„é€ æ–¹æ³•è¯´èµ·ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassPathXmlApplicationContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractXmlApplicationContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configResources<span class="token punctuation">;</span>
  
  <span class="token comment">// å¦‚æœå·²ç»æœ‰ ApplicationContext å¹¶éœ€è¦é…ç½®æˆçˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•</span>
  <span class="token keyword">public</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">public</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configLocations<span class="token punctuation">,</span> <span class="token keyword">boolean</span> refresh<span class="token punctuation">,</span> <span class="token class-name">ApplicationContext</span> parent<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ®æä¾›çš„è·¯å¾„ï¼Œå¤„ç†æˆé…ç½®æ–‡ä»¶æ•°ç»„(ä»¥åˆ†å·ã€é€—å·ã€ç©ºæ ¼ã€tabã€æ¢è¡Œç¬¦åˆ†å‰²)</span>
    <span class="token function">setConfigLocations</span><span class="token punctuation">(</span>configLocations<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>refresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ ¸å¿ƒæ–¹æ³•</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯ <code>refresh()</code>ï¼Œè¿™é‡Œç®€å•è¯´ä¸‹ä¸ºä»€ä¹ˆæ˜¯ refresh()ï¼Œè€Œä¸æ˜¯ init() è¿™ç§åå­—çš„æ–¹æ³•ã€‚å› ä¸º ApplicationContext å»ºç«‹èµ·æ¥ä»¥åï¼Œå…¶å®æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡è°ƒç”¨ refresh() è¿™ä¸ªæ–¹æ³•é‡å»ºçš„ï¼Œrefresh() ä¼šå°†åŸæ¥çš„ ApplicationContext é”€æ¯ï¼Œç„¶åå†é‡æ–°æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œã€‚</p>
<p>å¾€ä¸‹çœ‹ï¼Œrefresh() æ–¹æ³•é‡Œé¢è°ƒç”¨äº†é‚£ä¹ˆå¤šæ–¹æ³•ï¼Œå°±çŸ¥é“è‚¯å®šä¸ç®€å•äº†ï¼Œè¯·è¯»è€…å…ˆçœ‹ä¸ªå¤§æ¦‚ï¼Œç»†èŠ‚ä¹‹åä¼šè¯¦ç»†è¯´ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="token comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="token comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="token comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="token comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>
        
         <span class="token comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) æ–¹æ³•</span>
         <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="token comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="token comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚æ³¨æ„ï¼Œåˆ°è¿™é‡Œ Bean è¿˜æ²¡åˆå§‹åŒ–</span>
         <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œ</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="token comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="token comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆ</span>
         <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span>
                  <span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="token comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// Reset 'active' flag.</span>
         <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// Reset common introspection caches in Spring's core, since we</span>
         <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
         <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥æ¥è‚¢è§£è¿™ä¸ª refresh() æ–¹æ³•ã€‚</p>
<h3 id="â‘ -åˆ›å»º-Bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ"><a href="#â‘ -åˆ›å»º-Bean-å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="â‘  åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ"></a>â‘  åˆ›å»º Bean å®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œ</h3><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹ä»£ç ä¸­çš„å‡ ä¸ªæ³¨é‡Šå³å¯ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// è®°å½•å¯åŠ¨æ—¶é—´ï¼Œ</span>
   <span class="token comment">// å°† active å±æ€§è®¾ç½®ä¸º trueï¼Œclosed å±æ€§è®¾ç½®ä¸º falseï¼Œå®ƒä»¬éƒ½æ˜¯ AtomicBoolean ç±»å‹</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>startupDate <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Refreshing "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Initialize any placeholder property sources in the context environment</span>
   <span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ ¡éªŒ xml é…ç½®æ–‡ä»¶</span>
   <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateRequiredProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>earlyApplicationEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="â‘¡-åˆ›å»º-Bean-å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ-Bean"><a href="#â‘¡-åˆ›å»º-Bean-å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ-Bean" class="headerlink" title="â‘¡ åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean"></a>â‘¡ åˆ›å»º Bean å®¹å™¨ï¼ŒåŠ è½½å¹¶æ³¨å†Œ Bean</h3><p>æˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ä¸­çš„ä¸‹ä¸€è¡Œ obtainFreshBeanFactory()ã€‚</p>
<p>æ³¨æ„ï¼Œ<strong>è¿™ä¸ªæ–¹æ³•æ˜¯å…¨æ–‡æœ€é‡è¦çš„éƒ¨åˆ†ä¹‹ä¸€</strong>ï¼Œè¿™é‡Œå°†ä¼šåˆå§‹åŒ– BeanFactoryã€åŠ è½½ Beanã€æ³¨å†Œ Bean ç­‰ç­‰ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™æ­¥ç»“æŸåï¼ŒBean å¹¶æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ã€‚è¿™é‡ŒæŒ‡çš„æ˜¯ Bean å®ä¾‹å¹¶æœªåœ¨è¿™ä¸€æ­¥ç”Ÿæˆã€‚</p>
<p>// AbstractApplicationContext.java</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">ConfigurableListableBeanFactory</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å…³é—­æ—§çš„ BeanFactory (å¦‚æœæœ‰)ï¼Œåˆ›å»ºæ–°çš„ BeanFactoryï¼ŒåŠ è½½ Bean å®šä¹‰ã€æ³¨å†Œ Bean ç­‰ç­‰</span>
   <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// è¿”å›åˆšåˆšåˆ›å»ºçš„ BeanFactory</span>
   <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Bean factory for "</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> beanFactory<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>// AbstractRefreshableApplicationContext.java 120</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token comment">// å¦‚æœ ApplicationContext ä¸­å·²ç»åŠ è½½è¿‡ BeanFactory äº†ï¼Œé”€æ¯æ‰€æœ‰ Beanï¼Œå…³é—­ BeanFactory</span>
   <span class="token comment">// æ³¨æ„ï¼Œåº”ç”¨ä¸­ BeanFactory æœ¬æ¥å°±æ˜¯å¯ä»¥å¤šä¸ªçš„ï¼Œè¿™é‡Œå¯ä¸æ˜¯è¯´åº”ç”¨å…¨å±€æ˜¯å¦æœ‰ BeanFactoryï¼Œè€Œæ˜¯å½“å‰</span>
   <span class="token comment">// ApplicationContext æ˜¯å¦æœ‰ BeanFactory</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">closeBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆå§‹åŒ–ä¸€ä¸ª DefaultListableBeanFactoryï¼Œä¸ºä»€ä¹ˆç”¨è¿™ä¸ªï¼Œæˆ‘ä»¬é©¬ä¸Šè¯´ã€‚</span>
      <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">createBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç”¨äº BeanFactory çš„åºåˆ—åŒ–ï¼Œæˆ‘æƒ³ä¸éƒ¨åˆ†äººåº”è¯¥éƒ½ç”¨ä¸åˆ°</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setSerializationId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token comment">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œåˆ«è·Ÿä¸¢äº†ï¼Œå…·ä½“ç»†èŠ‚ä¹‹åè¯´</span>
      <span class="token comment">// è®¾ç½® BeanFactory çš„ä¸¤ä¸ªé…ç½®å±æ€§ï¼šæ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨</span>
      <span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token comment">// åŠ è½½ Bean åˆ° BeanFactory ä¸­</span>
      <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactoryMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> beanFactory<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContextException</span><span class="token punctuation">(</span><span class="token string">"I/O error parsing bean definition source for "</span> <span class="token operator">+</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>çœ‹åˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæˆ‘è§‰å¾—è¯»è€…å°±åº”è¯¥ç«™åœ¨é«˜å¤„çœ‹ ApplicationContext äº†ï¼ŒApplicationContext ç»§æ‰¿è‡ª BeanFactoryï¼Œä½†æ˜¯å®ƒä¸åº”è¯¥è¢«ç†è§£ä¸º BeanFactory çš„å®ç°ç±»ï¼Œè€Œæ˜¯è¯´å…¶å†…éƒ¨æŒæœ‰ä¸€ä¸ªå®ä¾‹åŒ–çš„ BeanFactoryï¼ˆDefaultListableBeanFactoryï¼‰ã€‚ä»¥åæ‰€æœ‰çš„ BeanFactory ç›¸å…³çš„æ“ä½œå…¶å®æ˜¯å§”æ‰˜ç»™è¿™ä¸ªå®ä¾‹æ¥å¤„ç†çš„ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬è¯´è¯´ä¸ºä»€ä¹ˆé€‰æ‹©å®ä¾‹åŒ– <strong>DefaultListableBeanFactory</strong> ï¼Ÿå‰é¢æˆ‘ä»¬è¯´äº†æœ‰ä¸ªå¾ˆé‡è¦çš„æ¥å£ ConfigurableListableBeanFactoryï¼Œå®ƒå®ç°äº† BeanFactory ä¸‹é¢ä¸€å±‚çš„æ‰€æœ‰ä¸‰ä¸ªæ¥å£ï¼Œæˆ‘æŠŠä¹‹å‰çš„ç»§æ‰¿å›¾å†æ‹¿è¿‡æ¥å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹ï¼š</p>
<p><img src="https://www.javadoop.com/blogimages/spring-context/3.png" alt="3"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° ConfigurableListableBeanFactory åªæœ‰ä¸€ä¸ªå®ç°ç±» DefaultListableBeanFactoryï¼Œè€Œä¸”å®ç°ç±» DefaultListableBeanFactory è¿˜é€šè¿‡å®ç°å³è¾¹çš„ AbstractAutowireCapableBeanFactory é€šåƒäº†å³è·¯ã€‚æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼Œæœ€åº•ä¸‹è¿™ä¸ªå®¶ä¼™ DefaultListableBeanFactory åŸºæœ¬ä¸Šæ˜¯æœ€ç‰›çš„ BeanFactory äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™è¾¹ä¼šä½¿ç”¨è¿™ä¸ªç±»æ¥å®ä¾‹åŒ–çš„åŸå› ã€‚</p>
<blockquote>
<p>å¦‚æœä½ æƒ³è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€å¾€ Spring IOC å®¹å™¨æ³¨å†Œæ–°çš„ beanï¼Œå°±ä¼šä½¿ç”¨åˆ°è¿™ä¸ªç±»ã€‚é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨è¿è¡Œæ—¶è·å¾—è¿™ä¸ªå®ä¾‹å‘¢ï¼Ÿ</p>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ ApplicationContext æ¥å£èƒ½è·å–åˆ° AutowireCapableBeanFactoryï¼Œå°±æ˜¯æœ€å³ä¸Šè§’é‚£ä¸ªï¼Œç„¶åå®ƒå‘ä¸‹è½¬å‹å°±èƒ½å¾—åˆ° DefaultListableBeanFactory äº†ã€‚</p>
<p>é‚£æ€ä¹ˆæ‹¿åˆ° ApplicationContext å®ä¾‹å‘¢ï¼Ÿå¦‚æœä½ ä¸ä¼šï¼Œè¯´æ˜ä½ æ²¡ç”¨è¿‡ Springã€‚</p>
</blockquote>
<p>åœ¨ç»§ç»­å¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ BeanDefinitionã€‚<strong>æˆ‘ä»¬è¯´ BeanFactory æ˜¯ Bean å®¹å™¨ï¼Œé‚£ä¹ˆ Bean åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<p>è¿™é‡Œçš„ BeanDefinition å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ Spring çš„ Beanï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å„ä¸ª Bean å…¶å®ä¼šè½¬æ¢æˆä¸€ä¸ªä¸ª BeanDefinition å­˜åœ¨äº Spring çš„ BeanFactory ä¸­ã€‚</p>
<p>æ‰€ä»¥ï¼Œå¦‚æœæœ‰äººé—®ä½  Bean æ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ è¦çŸ¥é“ Bean åœ¨ä»£ç å±‚é¢ä¸Šå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯ BeanDefinition çš„å®ä¾‹ã€‚</p>
<blockquote>
<p>BeanDefinition ä¸­ä¿å­˜äº†æˆ‘ä»¬çš„ Bean ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™ä¸ª Bean æŒ‡å‘çš„æ˜¯å“ªä¸ªç±»ã€æ˜¯å¦æ˜¯å•ä¾‹çš„ã€æ˜¯å¦æ‡’åŠ è½½ã€è¿™ä¸ª Bean ä¾èµ–äº†å“ªäº› Bean ç­‰ç­‰ã€‚</p>
</blockquote>
<h4 id="BeanDefinition-æ¥å£å®šä¹‰"><a href="#BeanDefinition-æ¥å£å®šä¹‰" class="headerlink" title="BeanDefinition æ¥å£å®šä¹‰"></a>BeanDefinition æ¥å£å®šä¹‰</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ BeanDefinition çš„æ¥å£å®šä¹‰ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinition</span> <span class="token keyword">extends</span> <span class="token class-name">AttributeAccessor</span><span class="token punctuation">,</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">{</span>

   <span class="token comment">// æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤åªæä¾› sington å’Œ prototype ä¸¤ç§ï¼Œ</span>
   <span class="token comment">// å¾ˆå¤šè¯»è€…å¯èƒ½çŸ¥é“è¿˜æœ‰ request, session, globalSession, application, websocket è¿™å‡ ç§ï¼Œ</span>
   <span class="token comment">// ä¸è¿‡ï¼Œå®ƒä»¬å±äºåŸºäº web çš„æ‰©å±•ã€‚</span>
   <span class="token class-name">String</span> SCOPE_SINGLETON <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>SCOPE_SINGLETON<span class="token punctuation">;</span>
   <span class="token class-name">String</span> SCOPE_PROTOTYPE <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span>SCOPE_PROTOTYPE<span class="token punctuation">;</span>

   <span class="token comment">// æ¯”è¾ƒä¸é‡è¦ï¼Œç›´æ¥è·³è¿‡å§</span>
   <span class="token keyword">int</span> ROLE_APPLICATION <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> ROLE_SUPPORT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> ROLE_INFRASTRUCTURE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®çˆ¶ Beanï¼Œè¿™é‡Œæ¶‰åŠåˆ° bean ç»§æ‰¿ï¼Œä¸æ˜¯ java ç»§æ‰¿ã€‚è¯·å‚è§é™„å½•çš„è¯¦ç»†ä»‹ç»</span>
   <span class="token comment">// ä¸€å¥è¯å°±æ˜¯ï¼šç»§æ‰¿çˆ¶ Bean çš„é…ç½®ä¿¡æ¯è€Œå·²</span>
   <span class="token keyword">void</span> <span class="token function">setParentName</span><span class="token punctuation">(</span><span class="token class-name">String</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// è·å–çˆ¶ Bean</span>
   <span class="token class-name">String</span> <span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// è®¾ç½® Bean çš„ç±»åç§°ï¼Œå°†æ¥æ˜¯è¦é€šè¿‡åå°„æ¥ç”Ÿæˆå®ä¾‹çš„</span>
   <span class="token keyword">void</span> <span class="token function">setBeanClassName</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token comment">// è·å– Bean çš„ç±»åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 
   <span class="token comment">// è®¾ç½® bean çš„ scope</span>
   <span class="token keyword">void</span> <span class="token function">setScope</span><span class="token punctuation">(</span><span class="token class-name">String</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">String</span> <span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®æ˜¯å¦æ‡’åŠ è½½</span>
   <span class="token keyword">void</span> <span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lazyInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token keyword">boolean</span> <span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®è¯¥ Bean ä¾èµ–çš„æ‰€æœ‰çš„ Beanï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–ä¸æ˜¯æŒ‡å±æ€§ä¾èµ–(å¦‚ @Autowire æ ‡è®°çš„)ï¼Œ</span>
   <span class="token comment">// æ˜¯ depends-on="" å±æ€§è®¾ç½®çš„å€¼ã€‚</span>
   <span class="token keyword">void</span> <span class="token function">setDependsOn</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿”å›è¯¥ Bean çš„æ‰€æœ‰ä¾èµ–</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è®¾ç½®è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­ï¼Œåªå¯¹æ ¹æ®ç±»å‹æ³¨å…¥æœ‰æ•ˆï¼Œ</span>
   <span class="token comment">// å¦‚æœæ ¹æ®åç§°æ³¨å…¥ï¼Œå³ä½¿è¿™è¾¹è®¾ç½®äº† falseï¼Œä¹Ÿæ˜¯å¯ä»¥çš„</span>
   <span class="token keyword">void</span> <span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¯¥ Bean æ˜¯å¦å¯ä»¥æ³¨å…¥åˆ°å…¶ä»– Bean ä¸­</span>
   <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸»è¦çš„ã€‚åŒä¸€æ¥å£çš„å¤šä¸ªå®ç°ï¼Œå¦‚æœä¸æŒ‡å®šåå­—çš„è¯ï¼ŒSpring ä¼šä¼˜å…ˆé€‰æ‹©è®¾ç½® primary ä¸º true çš„ bean</span>
   <span class="token keyword">void</span> <span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> primary<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦æ˜¯ primary çš„</span>
   <span class="token keyword">boolean</span> <span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¯¥ Bean é‡‡ç”¨å·¥å‚æ–¹æ³•ç”Ÿæˆï¼ŒæŒ‡å®šå·¥å‚åç§°ã€‚å¯¹å·¥å‚ä¸ç†Ÿæ‚‰çš„è¯»è€…ï¼Œè¯·å‚åŠ é™„å½•</span>
   <span class="token comment">// ä¸€å¥è¯å°±æ˜¯ï¼šæœ‰äº›å®ä¾‹ä¸æ˜¯ç”¨åå°„ç”Ÿæˆçš„ï¼Œè€Œæ˜¯ç”¨å·¥å‚æ¨¡å¼ç”Ÿæˆçš„</span>
   <span class="token keyword">void</span> <span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span><span class="token class-name">String</span> factoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è·å–å·¥å‚åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getFactoryBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// æŒ‡å®šå·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="token keyword">void</span> <span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token class-name">String</span> factoryMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è·å–å·¥å‚ç±»ä¸­çš„ å·¥å‚æ–¹æ³•åç§°</span>
   <span class="token class-name">String</span> <span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ„é€ å™¨å‚æ•°</span>
   <span class="token class-name">ConstructorArgumentValues</span> <span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Bean ä¸­çš„å±æ€§å€¼ï¼Œåé¢ç»™ bean æ³¨å…¥å±æ€§å€¼çš„æ—¶å€™ä¼šè¯´åˆ°</span>
   <span class="token class-name">MutablePropertyValues</span> <span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦ singleton</span>
   <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ˜¯å¦ prototype</span>
   <span class="token keyword">boolean</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¿™ä¸ª Bean æ˜¯è¢«è®¾ç½®ä¸º abstractï¼Œé‚£ä¹ˆä¸èƒ½å®ä¾‹åŒ–ï¼Œ</span>
   <span class="token comment">// å¸¸ç”¨äºä½œä¸º çˆ¶bean ç”¨äºç»§æ‰¿ï¼Œå…¶å®ä¹Ÿå¾ˆå°‘ç”¨......</span>
   <span class="token keyword">boolean</span> <span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">int</span> <span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> <span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">BeanDefinition</span> <span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>è¿™ä¸ª BeanDefinition å…¶å®å·²ç»åŒ…å«å¾ˆå¤šçš„ä¿¡æ¯äº†ï¼Œæš‚æ—¶ä¸æ¸…æ¥šæ‰€æœ‰çš„æ–¹æ³•å¯¹åº”ä»€ä¹ˆä¸œè¥¿æ²¡å…³ç³»ï¼Œå¸Œæœ›çœ‹å®Œæœ¬æ–‡åè¯»è€…å¯ä»¥å½»åº•ææ¸…æ¥šé‡Œé¢çš„æ‰€æœ‰ä¸œè¥¿ã€‚</p>
<p>è¿™é‡Œæ¥å£è™½ç„¶é‚£ä¹ˆå¤šï¼Œä½†æ˜¯æ²¡æœ‰ç±»ä¼¼ getInstance() è¿™ç§æ–¹æ³•æ¥è·å–æˆ‘ä»¬å®šä¹‰çš„ç±»çš„å®ä¾‹ï¼ŒçœŸæ­£çš„æˆ‘ä»¬å®šä¹‰çš„ç±»ç”Ÿæˆçš„å®ä¾‹åˆ°å“ªé‡Œå»äº†å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œè¿™ä¸ªè¦å¾ˆåé¢æ‰èƒ½è®²åˆ°ã€‚</p>
</blockquote>
<p>æœ‰äº† BeanDefinition çš„æ¦‚å¿µä»¥åï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ refreshBeanFactory() æ–¹æ³•ä¸­çš„å‰©ä½™éƒ¨åˆ†ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è™½ç„¶åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä½†è·¯è¿˜å¾ˆé•¿å•Šã€‚ã€‚ã€‚</p>
<h4 id="customizeBeanFactory"><a href="#customizeBeanFactory" class="headerlink" title="customizeBeanFactory"></a>customizeBeanFactory</h4><p>customizeBeanFactory(beanFactory) æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é…ç½®æ˜¯å¦å…è®¸ BeanDefinition è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯å¼•ç”¨ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowBeanDefinitionOverriding <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦å…è®¸ Bean å®šä¹‰è¦†ç›–</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowBeanDefinitionOverriding<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¯å¦å…è®¸ Bean é—´çš„å¾ªç¯ä¾èµ–</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setAllowCircularReferences</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>BeanDefinition çš„è¦†ç›–é—®é¢˜å¯èƒ½ä¼šæœ‰å¼€å‘è€…ç¢°åˆ°è¿™ä¸ªå‘ï¼Œå°±æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean æ—¶ä½¿ç”¨äº†ç›¸åŒçš„ id æˆ– nameï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullï¼Œå¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>
<p>å¾ªç¯å¼•ç”¨ä¹Ÿå¾ˆå¥½ç†è§£ï¼šA ä¾èµ– Bï¼Œè€Œ B ä¾èµ– Aã€‚æˆ– A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C ä¾èµ– Aã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring å…è®¸å¾ªç¯ä¾èµ–ï¼Œå½“ç„¶å¦‚æœä½ åœ¨ A çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– Bï¼Œåœ¨ B çš„æ„é€ æ–¹æ³•ä¸­ä¾èµ– A æ˜¯ä¸è¡Œçš„ã€‚</p>
<p>è‡³äºè¿™ä¸¤ä¸ªå±æ€§æ€ä¹ˆé…ç½®ï¼Ÿæˆ‘åœ¨é™„å½•ä¸­è¿›è¡Œäº†ä»‹ç»ï¼Œå°¤å…¶å¯¹äºè¦†ç›–é—®é¢˜ï¼Œå¾ˆå¤šäººéƒ½å¸Œæœ›ç¦æ­¢å‡ºç° Bean è¦†ç›–ï¼Œå¯æ˜¯ Spring é»˜è®¤æ˜¯ä¸åŒæ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¦†ç›–çš„ã€‚</p>
<p>ä¹‹åçš„æºç ä¸­è¿˜ä¼šå‡ºç°è¿™ä¸¤ä¸ªå±æ€§ï¼Œè¯»è€…æœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ï¼Œå®ƒä»¬ä¸æ˜¯éå¸¸é‡è¦ã€‚</p>
<h4 id="åŠ è½½-Bean-loadBeanDefinitions"><a href="#åŠ è½½-Bean-loadBeanDefinitions" class="headerlink" title="åŠ è½½ Bean: loadBeanDefinitions"></a>åŠ è½½ Bean: loadBeanDefinitions</h4><p>æ¥ä¸‹æ¥æ˜¯æœ€é‡è¦çš„ loadBeanDefinitions(beanFactory) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•å°†æ ¹æ®é…ç½®ï¼ŒåŠ è½½å„ä¸ª Beanï¼Œç„¶åæ”¾åˆ° BeanFactory ä¸­ã€‚</p>
<p>è¯»å–é…ç½®çš„æ“ä½œåœ¨ XmlBeanDefinitionReader ä¸­ï¼Œå…¶è´Ÿè´£åŠ è½½é…ç½®ã€è§£æã€‚</p>
<p>// AbstractXmlApplicationContext.java 80</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ–¹æ³•å°†é€šè¿‡ä¸€ä¸ª XmlBeanDefinitionReader å®ä¾‹æ¥åŠ è½½å„ä¸ª Beanã€‚*/</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token comment">// ç»™è¿™ä¸ª BeanFactory å®ä¾‹åŒ–ä¸€ä¸ª XmlBeanDefinitionReader</span>
   <span class="token class-name">XmlBeanDefinitionReader</span> beanDefinitionReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// Configure the bean definition reader with this context's</span>
   <span class="token comment">// resource loading environment.</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEnvironment</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanDefinitionReader<span class="token punctuation">.</span><span class="token function">setEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEntityResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// åˆå§‹åŒ– BeanDefinitionReaderï¼Œå…¶å®è¿™ä¸ªæ˜¯æä¾›ç»™å­ç±»è¦†å†™çš„ï¼Œ</span>
   <span class="token comment">// æˆ‘çœ‹äº†ä¸€ä¸‹ï¼Œæ²¡æœ‰ç±»è¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å§‘ä¸”å½“åšä¸é‡è¦å§</span>
   <span class="token function">initBeanDefinitionReader</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// é‡ç‚¹æ¥äº†ï¼Œç»§ç»­å¾€ä¸‹</span>
   <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanDefinitionReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç°åœ¨è¿˜åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨åˆšåˆšåˆå§‹åŒ–çš„ Reader å¼€å§‹æ¥åŠ è½½ xml é…ç½®ï¼Œè¿™å—ä»£ç è¯»è€…å¯ä»¥é€‰æ‹©æ€§è·³è¿‡ï¼Œä¸æ˜¯å¾ˆé‡è¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢è¿™ä¸ªä»£ç å—ï¼Œè¯»è€…å¯ä»¥å¾ˆè½»æ¾åœ°ç•¥è¿‡ã€‚</p>
<p>// AbstractXmlApplicationContext.java 120</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">XmlBeanDefinitionReader</span> reader<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configResources <span class="token operator">=</span> <span class="token function">getConfigResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>configResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¾€ä¸‹çœ‹</span>
      reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> configLocations <span class="token operator">=</span> <span class="token function">getConfigLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>configLocations <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2</span>
      reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configLocations<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¸Šé¢è™½ç„¶æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸è¿‡ç¬¬äºŒä¸ªåˆ†æ”¯å¾ˆå¿«é€šè¿‡è§£æè·¯å¾„è½¬æ¢ä¸º Resource ä»¥åä¹Ÿä¼šè¿›åˆ°è¿™é‡Œ</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> resources<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>resources<span class="token punctuation">,</span> <span class="token string">"Resource array must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">// æ³¨æ„è¿™é‡Œæ˜¯ä¸ª for å¾ªç¯ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ª resource</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç»§ç»­å¾€ä¸‹çœ‹</span>
      counter <span class="token operator">+=</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// æœ€åè¿”å› counterï¼Œè¡¨ç¤ºæ€»å…±åŠ è½½äº†å¤šå°‘çš„ BeanDefinition</span>
   <span class="token keyword">return</span> counter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// XmlBeanDefinitionReader 303</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// XmlBeanDefinitionReader 314</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">EncodedResource</span> encodedResource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">,</span> <span class="token string">"EncodedResource must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Loading XML bean definitions from "</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// ç”¨ä¸€ä¸ª ThreadLocal æ¥å­˜æ”¾é…ç½®æ–‡ä»¶èµ„æº</span>
   <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EncodedResource</span><span class="token punctuation">&gt;</span></span> currentResources <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>currentResources <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EncodedResource</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentResources<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
            <span class="token string">"Detected cyclic loading of "</span> <span class="token operator">+</span> encodedResource <span class="token operator">+</span> <span class="token string">" - check your import definitions!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token class-name">InputSource</span> inputSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InputSource</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inputSource<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">.</span><span class="token function">getEncoding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token comment">// æ ¸å¿ƒéƒ¨åˆ†æ˜¯è¿™é‡Œï¼Œå¾€ä¸‹é¢çœ‹</span>
         <span class="token keyword">return</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
            <span class="token string">"IOException parsing XML document from "</span> <span class="token operator">+</span> encodedResource<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      currentResources<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>encodedResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentResources<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>resourcesCurrentlyBeingLoaded<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 388 è¡Œ</span>
<span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">InputSource</span> inputSource<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™é‡Œå°±ä¸çœ‹äº†ï¼Œå°† xml æ–‡ä»¶è½¬æ¢ä¸º Document å¯¹è±¡</span>
      <span class="token class-name">Document</span> doc <span class="token operator">=</span> <span class="token function">doLoadDocument</span><span class="token punctuation">(</span>inputSource<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ç»§ç»­</span>
      <span class="token keyword">return</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿˜åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œç¬¬ 505 è¡Œ</span>
<span class="token comment">// è¿”å›å€¼ï¼šè¿”å›ä»å½“å‰é…ç½®æ–‡ä»¶åŠ è½½äº†å¤šå°‘æ•°é‡çš„ Bean</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
   <span class="token class-name">BeanDefinitionDocumentReader</span> documentReader <span class="token operator">=</span> <span class="token function">createBeanDefinitionDocumentReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">int</span> countBefore <span class="token operator">=</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è¿™é‡Œ</span>
   documentReader<span class="token punctuation">.</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>doc<span class="token punctuation">,</span> <span class="token function">createReaderContext</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> countBefore<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// DefaultBeanDefinitionDocumentReader 90</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Document</span> doc<span class="token punctuation">,</span> <span class="token class-name">XmlReaderContext</span> readerContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext <span class="token operator">=</span> readerContext<span class="token punctuation">;</span>
   logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Loading bean definitions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Element</span> root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">getDocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ä» xml æ ¹èŠ‚ç‚¹å¼€å§‹è§£ææ–‡ä»¶</span>
   <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>         <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»è¿‡æ¼«é•¿çš„é“¾è·¯ï¼Œä¸€ä¸ªé…ç½®æ–‡ä»¶ç»ˆäºè½¬æ¢ä¸ºä¸€é¢— DOM æ ‘äº†ï¼Œæ³¨æ„ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯å…¶ä¸­ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸æ˜¯æ‰€æœ‰çš„ï¼Œè¯»è€…å¯ä»¥çœ‹åˆ°ä¸Šé¢æœ‰ä¸ª for å¾ªç¯çš„ã€‚ä¸‹é¢å¼€å§‹ä»æ ¹èŠ‚ç‚¹å¼€å§‹è§£æï¼š</p>
<h5 id="doRegisterBeanDefinitionsï¼š"><a href="#doRegisterBeanDefinitionsï¼š" class="headerlink" title="doRegisterBeanDefinitionsï¼š"></a>doRegisterBeanDefinitionsï¼š</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// DefaultBeanDefinitionDocumentReader 116</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// æˆ‘ä»¬çœ‹åå­—å°±çŸ¥é“ï¼ŒBeanDefinitionParserDelegate å¿…å®šæ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œå®ƒè´Ÿè´£è§£æ Bean å®šä¹‰ï¼Œ</span>
   <span class="token comment">// è¿™é‡Œä¸ºä»€ä¹ˆè¦å®šä¹‰ä¸€ä¸ª parent? çœ‹åˆ°åé¢å°±çŸ¥é“äº†ï¼Œæ˜¯é€’å½’é—®é¢˜ï¼Œ</span>
   <span class="token comment">// å› ä¸º &lt;beans /&gt; å†…éƒ¨æ˜¯å¯ä»¥å®šä¹‰ &lt;beans /&gt; çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•çš„ root å…¶å®ä¸ä¸€å®šå°±æ˜¯ xml çš„æ ¹èŠ‚ç‚¹ï¼Œä¹Ÿå¯ä»¥æ˜¯åµŒå¥—åœ¨é‡Œé¢çš„ &lt;beans /&gt; èŠ‚ç‚¹ï¼Œä»æºç åˆ†æçš„è§’åº¦ï¼Œæˆ‘ä»¬å½“åšæ ¹èŠ‚ç‚¹å°±å¥½äº†</span>
   <span class="token class-name">BeanDefinitionParserDelegate</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> <span class="token function">createDelegate</span><span class="token punctuation">(</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™å—è¯´çš„æ˜¯æ ¹èŠ‚ç‚¹ &lt;beans ... profile="dev" /&gt; ä¸­çš„ profile æ˜¯å¦æ˜¯å½“å‰ç¯å¢ƒéœ€è¦çš„ï¼Œ</span>
      <span class="token comment">// å¦‚æœå½“å‰ç¯å¢ƒé…ç½®çš„ profile ä¸åŒ…å«æ­¤ profileï¼Œé‚£å°±ç›´æ¥ return äº†ï¼Œä¸å¯¹æ­¤ &lt;beans /&gt; è§£æ</span>
      <span class="token comment">// ä¸ç†Ÿæ‚‰ profile ä¸ºä½•ç‰©ï¼Œä¸ç†Ÿæ‚‰æ€ä¹ˆé…ç½® profile è¯»è€…çš„è¯·ç§»æ­¥é™„å½•åŒº</span>
      <span class="token class-name">String</span> profileSpec <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>PROFILE_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>profileSpec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specifiedProfiles <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>
               profileSpec<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span><span class="token punctuation">.</span>MULTI_VALUE_ATTRIBUTE_DELIMITERS<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acceptsProfiles</span><span class="token punctuation">(</span>specifiedProfiles<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Skipped XML bean definition file due to specified profiles ["</span> <span class="token operator">+</span> profileSpec <span class="token operator">+</span>
                     <span class="token string">"] not matching: "</span> <span class="token operator">+</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token function">preProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é’©å­</span>
   <span class="token comment">// å¾€ä¸‹çœ‹</span>
   <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">postProcessXml</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é’©å­</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> parent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>preProcessXml(root) å’Œ postProcessXml(root) æ˜¯ç»™å­ç±»ç”¨çš„é’©å­æ–¹æ³•ï¼Œé‰´äºæ²¡æœ‰è¢«ä½¿ç”¨åˆ°ï¼Œä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥è·³è¿‡ã€‚</p>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº† profile çš„é—®é¢˜ï¼Œå¯¹äºä¸äº†è§£çš„è¯»è€…ï¼Œæˆ‘åœ¨é™„å½•ä¸­å¯¹ profile åšäº†ç®€å•çš„è§£é‡Šï¼Œè¯»è€…å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œçœ‹æ ¸å¿ƒè§£ææ–¹æ³• parseBeanDefinitions(root, this.delegate) :</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// default namespace æ¶‰åŠåˆ°çš„å°±å››ä¸ªæ ‡ç­¾ &lt;import /&gt;ã€&lt;alias /&gt;ã€&lt;bean /&gt; å’Œ &lt;beans /&gt;ï¼Œ</span>
<span class="token comment">// å…¶ä»–çš„å±äº custom çš„</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Element</span> root<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">NodeList</span> nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">Node</span> node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Element</span> ele <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Element</span><span class="token punctuation">)</span> node<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// è§£æ default namespace ä¸‹é¢çš„å‡ ä¸ªå…ƒç´ </span>
               <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// è§£æå…¶ä»– namespace çš„å…ƒç´ </span>
               delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¯ä¸ªé…ç½®æ¥è¯´ï¼Œåˆ†åˆ«è¿›å…¥åˆ° parseDefaultElement(ele, delegate); å’Œ delegate.parseCustomElement(ele); è¿™ä¸¤ä¸ªåˆ†æ”¯äº†ã€‚</p>
<p>parseDefaultElement(ele, delegate) ä»£è¡¨è§£æçš„èŠ‚ç‚¹æ˜¯ <code>&lt;import /&gt;</code>ã€<code>&lt;alias /&gt;</code>ã€<code>&lt;bean /&gt;</code>ã€<code>&lt;beans /&gt;</code> è¿™å‡ ä¸ªã€‚</p>
<blockquote>
<p>è¿™é‡Œçš„å››ä¸ªæ ‡ç­¾ä¹‹æ‰€ä»¥æ˜¯ <strong>default</strong> çš„ï¼Œæ˜¯å› ä¸ºå®ƒä»¬æ˜¯å¤„äºè¿™ä¸ª namespace ä¸‹å®šä¹‰çš„ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">http://www.springframework.org/schema/beans<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åˆåˆ°åˆå­¦è€…ç§‘æ™®æ—¶é—´ï¼Œä¸ç†Ÿæ‚‰ namespace çš„è¯»è€…è¯·çœ‹ä¸‹é¢è´´å‡ºæ¥çš„ xmlï¼Œè¿™é‡Œçš„ç¬¬äºŒè¡Œ <strong>xmlns</strong> å°±æ˜¯å’¯ã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
         http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">"</span></span>
    <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è€Œå¯¹äºå…¶ä»–çš„æ ‡ç­¾ï¼Œå°†è¿›å…¥åˆ° delegate.parseCustomElement(element) è¿™ä¸ªåˆ†æ”¯ã€‚å¦‚æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨åˆ°çš„ <code>&lt;mvc /&gt;</code>ã€<code>&lt;task /&gt;</code>ã€<code>&lt;context /&gt;</code>ã€<code>&lt;aop /&gt;</code>ç­‰ã€‚</p>
<p>è¿™äº›å±äºæ‰©å±•ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨ä¸Šé¢è¿™äº› â€é defaultâ€œ æ ‡ç­¾ï¼Œé‚£ä¹ˆä¸Šé¢çš„ xml å¤´éƒ¨çš„åœ°æ–¹ä¹Ÿè¦å¼•å…¥ç›¸åº”çš„ namespace å’Œ .xsd æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚åŒæ—¶ä»£ç ä¸­éœ€è¦æä¾›ç›¸åº”çš„ parser æ¥è§£æï¼Œå¦‚ MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandler ç­‰ã€‚</p>
<p>å‡å¦‚è¯»è€…æƒ³åˆ†æ <code>&lt;context:property-placeholder location="classpath:xx.properties" /&gt;</code> çš„å®ç°åŸç†ï¼Œå°±åº”è¯¥åˆ° ContextNamespaceHandler ä¸­æ‰¾ç­”æ¡ˆã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
   <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
   <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
   <span class="token attr-name"><span class="token namespace">xmlns:</span>mvc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/mvc<span class="token punctuation">"</span></span>
   <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
        http://www.springframework.org/schema/beans 
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc   
        http://www.springframework.org/schema/mvc/spring-mvc.xsd  
    <span class="token punctuation">"</span></span>
   <span class="token attr-name">default-autowire</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>byName<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åŒç†ï¼Œä»¥åä½ è¦æ˜¯ç¢°åˆ° <code>&lt;dubbo /&gt;</code> è¿™ç§æ ‡ç­¾ï¼Œé‚£ä¹ˆå°±åº”è¯¥æœä¸€æœæ˜¯ä¸æ˜¯æœ‰ DubboNamespaceHandler è¿™ä¸ªå¤„ç†ç±»ã€‚</p>
</blockquote>
<p>å›è¿‡ç¥æ¥ï¼Œçœ‹çœ‹å¤„ç† default æ ‡ç­¾çš„æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> IMPORT_ELEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;import /&gt; æ ‡ç­¾</span>
      <span class="token function">importBeanDefinitionResource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> ALIAS_ELEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;alias /&gt; æ ‡ç­¾å®šä¹‰</span>
      <span class="token comment">// &lt;alias name="fromName" alias="toName"/&gt;</span>
      <span class="token function">processAliasRegistration</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> BEAN_ELEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† &lt;bean /&gt; æ ‡ç­¾å®šä¹‰ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘ä»¬çš„é‡ç‚¹å§</span>
      <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">nodeNameEquals</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> NESTED_BEANS_ELEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœç¢°åˆ°çš„æ˜¯åµŒå¥—çš„ &lt;beans /&gt; æ ‡ç­¾ï¼Œéœ€è¦é€’å½’</span>
      <span class="token function">doRegisterBeanDefinitions</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæ¯ä¸ªæ ‡ç­¾éƒ½è¯´ï¼Œé‚£æˆ‘ä¸åè¡€ï¼Œä½ ä»¬éƒ½è¦åè¡€äº†ã€‚æˆ‘ä»¬æŒ‘æˆ‘ä»¬çš„é‡ç‚¹ <code>&lt;bean /&gt;</code> æ ‡ç­¾å‡ºæ¥è¯´ã€‚</p>
<h5 id="processBeanDefinition-è§£æ-bean-æ ‡ç­¾"><a href="#processBeanDefinition-è§£æ-bean-æ ‡ç­¾" class="headerlink" title="processBeanDefinition è§£æ bean æ ‡ç­¾"></a>processBeanDefinition è§£æ bean æ ‡ç­¾</h5><p>ä¸‹é¢æ˜¯ processBeanDefinition è§£æ <code>&lt;bean /&gt;</code> æ ‡ç­¾ï¼š</p>
<p>// DefaultBeanDefinitionDocumentReader 298</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥ï¼Œç„¶åå°è£…åˆ°ä¸€ä¸ª BeanDefinitionHolder ä¸­ï¼Œç»†èŠ‚å¾€ä¸‹çœ‹</span>
   <span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// ä¸‹é¢çš„å‡ è¡Œå…ˆä¸è¦çœ‹ï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œè·³è¿‡å…ˆï¼Œåé¢ä¼šç»§ç»­è¯´çš„</span>
  
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// Register the final decorated instance.</span>
         <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to register bean definition with name '"</span> <span class="token operator">+</span>
               bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Send registration event.</span>
      <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç»§ç»­å¾€ä¸‹çœ‹æ€ä¹ˆè§£æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹ <strong><code>&lt;bean /&gt;</code></strong> æ ‡ç­¾ä¸­å¯ä»¥å®šä¹‰å“ªäº›å±æ€§ï¼š</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>class</td>
<td>ç±»çš„å…¨é™å®šå</td>
</tr>
<tr>
<td>name</td>
<td>å¯æŒ‡å®š idã€name(ç”¨é€—å·ã€åˆ†å·ã€ç©ºæ ¼åˆ†éš”)</td>
</tr>
<tr>
<td>scope</td>
<td>ä½œç”¨åŸŸ</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>æŒ‡å®šæ„é€ å‚æ•°</td>
</tr>
<tr>
<td>properties</td>
<td>è®¾ç½®å±æ€§çš„å€¼</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(é»˜è®¤å€¼)ã€byNameã€byTypeã€ constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>æ˜¯å¦æ‡’åŠ è½½(å¦‚æœè¢«éæ‡’åŠ è½½çš„beanä¾èµ–äº†é‚£ä¹ˆå…¶å®ä¹Ÿå°±ä¸èƒ½æ‡’åŠ è½½äº†)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean å±æ€§è®¾ç½®å®Œæˆåï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean é”€æ¯åçš„å›è°ƒæ–¹æ³•</td>
</tr>
</tbody></table>
<p>ä¸Šé¢è¡¨æ ¼ä¸­çš„å†…å®¹æˆ‘æƒ³å¤§å®¶éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œå¦‚æœä¸ç†Ÿæ‚‰ï¼Œé‚£å°±æ˜¯ä½ ä¸å¤Ÿäº†è§£ Spring çš„é…ç½®äº†ã€‚</p>
<p>ç®€å•åœ°è¯´å°±æ˜¯åƒä¸‹é¢è¿™æ ·å­ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleBean<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>name1, name2, name3<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.ExampleBean<span class="token punctuation">"</span></span>
      <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>singleton<span class="token punctuation">"</span></span> <span class="token attr-name">lazy-init</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cleanup<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  
    <span class="token comment">&lt;!-- å¯ä»¥ç”¨ä¸‹é¢ä¸‰ç§å½¢å¼æŒ‡å®šæ„é€ å‚æ•° --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>int<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7500000<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>years<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7500000<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>7500000<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  
    <span class="token comment">&lt;!-- property çš„å‡ ç§æƒ…å†µ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>beanOne<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ref</span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anotherExampleBean<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>beanTwo<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yetAnotherBean<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>integerProperty<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢ä¸¾ä¾‹å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ factory-beanã€factory-methodã€<code>&lt;lockup-method /&gt;</code>ã€<code>&lt;replaced-method /&gt;</code>ã€<code>&lt;meta /&gt;</code>ã€<code>&lt;qualifier /&gt;</code> è¿™å‡ ä¸ªï¼Œå¤§å®¶æ˜¯ä¸æ˜¯ç†Ÿæ‚‰å‘¢ï¼Ÿè‡ªå·±æ£€éªŒä¸€ä¸‹è‡ªå·±å¯¹ Spring ä¸­ bean çš„äº†è§£ç¨‹åº¦ã€‚</p>
<p>æœ‰äº†ä»¥ä¸Šè¿™äº›çŸ¥è¯†ä»¥åï¼Œæˆ‘ä»¬å†ç»§ç»­å¾€é‡Œçœ‹æ€ä¹ˆè§£æ bean å…ƒç´ ï¼Œæ˜¯æ€ä¹ˆè½¬æ¢åˆ° BeanDefinitionHolder çš„ã€‚</p>
<p>// BeanDefinitionParserDelegate 428</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">String</span> id <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>ID_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> nameAttr <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>NAME_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> aliases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
   <span class="token comment">// å°† name å±æ€§çš„å®šä¹‰æŒ‰ç…§ â€œé€—å·ã€åˆ†å·ã€ç©ºæ ¼â€ åˆ‡åˆ†ï¼Œå½¢æˆä¸€ä¸ª åˆ«ååˆ—è¡¨æ•°ç»„ï¼Œ</span>
   <span class="token comment">// å½“ç„¶ï¼Œå¦‚æœä½ ä¸å®šä¹‰ name å±æ€§çš„è¯ï¼Œå°±æ˜¯ç©ºçš„äº†</span>
   <span class="token comment">// æˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ id å’Œ name çš„é…ç½®ï¼Œå¤§å®¶å¯ä»¥çœ‹ä¸€çœ¼ï¼Œæœ‰ä¸ª20ç§’å°±å¯ä»¥äº†</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nameArr <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span>nameAttr<span class="token punctuation">,</span> MULTI_VALUE_ATTRIBUTE_DELIMITERS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      aliases<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>nameArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">String</span> beanName <span class="token operator">=</span> id<span class="token punctuation">;</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šid, é‚£ä¹ˆç”¨åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªåå­—ä½œä¸ºbeanName</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>aliases<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanName <span class="token operator">=</span> aliases<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"No XML 'id' specified - using '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
               <span class="token string">"' as bean name and "</span> <span class="token operator">+</span> aliases <span class="token operator">+</span> <span class="token string">" as aliases"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkNameUniqueness</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
  
   <span class="token comment">// æ ¹æ® &lt;bean ...&gt;...&lt;/bean&gt; ä¸­çš„é…ç½®åˆ›å»º BeanDefinitionï¼Œç„¶åæŠŠé…ç½®ä¸­çš„ä¿¡æ¯éƒ½è®¾ç½®åˆ°å®ä¾‹ä¸­,</span>
   <span class="token comment">// ç»†èŠ‚åé¢ç»†è¯´ï¼Œå…ˆçŸ¥é“ä¸‹é¢è¿™è¡Œç»“æŸåï¼Œä¸€ä¸ª BeanDefinition å®ä¾‹å°±å‡ºæ¥äº†ã€‚</span>
   <span class="token class-name">AbstractBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
   <span class="token comment">// åˆ°è¿™é‡Œï¼Œæ•´ä¸ª &lt;bean /&gt; æ ‡ç­¾å°±ç®—è§£æç»“æŸäº†ï¼Œä¸€ä¸ª BeanDefinition å°±å½¢æˆäº†ã€‚</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœéƒ½æ²¡æœ‰è®¾ç½® id å’Œ nameï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ beanName å°±ä¼šä¸º nullï¼Œè¿›å…¥ä¸‹é¢è¿™å—ä»£ç äº§ç”Ÿ</span>
      <span class="token comment">// å¦‚æœè¯»è€…ä¸æ„Ÿå…´è¶£çš„è¯ï¼Œæˆ‘è§‰å¾—ä¸éœ€è¦å…³å¿ƒè¿™å—ä»£ç ï¼Œå¯¹æœ¬æ–‡æºç åˆ†ææ¥è¯´ï¼Œè¿™äº›ä¸œè¥¿ä¸é‡è¦</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>containingBean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// æŒ‰ç…§æˆ‘ä»¬çš„æ€è·¯ï¼Œè¿™é‡Œ containingBean æ˜¯ null çš„</span>
               beanName <span class="token operator">=</span> <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>
                     beanDefinition<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ id å’Œ nameï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼•è¨€é‡Œçš„é‚£ä¸ªä¾‹å­ï¼š</span>
               <span class="token comment">//   1. beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0</span>
               <span class="token comment">//   2. beanClassName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl</span>
              
               beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
               
               <span class="token class-name">String</span> beanClassName <span class="token operator">=</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClassName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                     beanName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> beanClassName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBeanNameInUse</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment">// æŠŠ beanClassName è®¾ç½®ä¸º Bean çš„åˆ«å</span>
                  aliases<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Neither XML 'id' nor 'name' specified - "</span> <span class="token operator">+</span>
                     <span class="token string">"using generated bean name ["</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliasesArray <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>aliases<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è¿”å› BeanDefinitionHolder</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> aliasesArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åï¼Œæˆ‘ä»¬å†çœ‹çœ‹æ€ä¹ˆæ ¹æ®é…ç½®åˆ›å»º BeanDefinition å®ä¾‹çš„ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>
      <span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> containingBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanEntry</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>CLASS_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      className <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>CLASS_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">String</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ele<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span>PARENT_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         parent <span class="token operator">=</span> ele<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>PARENT_ATTRIBUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ›å»º BeanDefinitionï¼Œç„¶åè®¾ç½®ç±»ä¿¡æ¯è€Œå·²ï¼Œå¾ˆç®€å•ï¼Œå°±ä¸è´´ä»£ç äº†</span>
      <span class="token class-name">AbstractBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">createBeanDefinition</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanDefinition çš„ä¸€å †å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰åœ¨ AbstractBeanDefinition ä¸­</span>
      <span class="token function">parseBeanDefinitionAttributes</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> containingBean<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      bd<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token class-name">DomUtils</span><span class="token punctuation">.</span><span class="token function">getChildElementValueByTagName</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> DESCRIPTION_ELEMENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
      <span class="token comment">/**
       * ä¸‹é¢çš„ä¸€å †æ˜¯è§£æ &lt;bean&gt;......&lt;/bean&gt; å†…éƒ¨çš„å­å…ƒç´ ï¼Œ
       * è§£æå‡ºæ¥ä»¥åçš„ä¿¡æ¯éƒ½æ”¾åˆ° bd çš„å±æ€§ä¸­
       */</span>
     
      <span class="token comment">// è§£æ &lt;meta /&gt;</span>
      <span class="token function">parseMetaElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;lookup-method /&gt;</span>
      <span class="token function">parseLookupOverrideSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;replaced-method /&gt;</span>
      <span class="token function">parseReplacedMethodSubElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è§£æ &lt;constructor-arg /&gt;</span>
      <span class="token function">parseConstructorArgElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;property /&gt;</span>
      <span class="token function">parsePropertyElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è§£æ &lt;qualifier /&gt;</span>
      <span class="token function">parseQualifierElements</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      bd<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readerContext<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bd<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span><span class="token function">extractSource</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> bd<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Bean class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"] not found"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoClassDefFoundError</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Class that bean class ["</span> <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"] depends on not found"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Unexpected failure during bean definition parsing"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>parseState<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†æ ¹æ® <code>&lt;bean /&gt;</code> é…ç½®åˆ›å»ºäº†ä¸€ä¸ª BeanDefinitionHolder å®ä¾‹ã€‚æ³¨æ„ï¼Œæ˜¯ä¸€ä¸ªã€‚</p>
<p>æˆ‘ä»¬å›åˆ°è§£æ <code>&lt;bean /&gt;</code> çš„å…¥å£æ–¹æ³•:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">Element</span> ele<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParserDelegate</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// å°† &lt;bean /&gt; èŠ‚ç‚¹è½¬æ¢ä¸º BeanDefinitionHolderï¼Œå°±æ˜¯ä¸Šé¢è¯´çš„ä¸€å †</span>
   <span class="token class-name">BeanDefinitionHolder</span> bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè¿›è¡Œç›¸åº”çš„è§£æï¼Œå…ˆå¿½ç•¥</span>
      bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// æˆ‘ä»¬æŠŠè¿™æ­¥å«åš æ³¨å†ŒBean å§</span>
         <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to register bean definition with name '"</span> <span class="token operator">+</span>
               bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶ï¼Œæœ¬æ–‡ä¸å±•å¼€è¯´è¿™ä¸ª</span>
      <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¤§å®¶å†ä»”ç»†çœ‹ä¸€ä¸‹è¿™å—å§ï¼Œæˆ‘ä»¬åé¢å°±ä¸å›æ¥è¯´è¿™ä¸ªäº†ã€‚è¿™é‡Œå·²ç»æ ¹æ®ä¸€ä¸ª <code>&lt;bean /&gt;</code> æ ‡ç­¾äº§ç”Ÿäº†ä¸€ä¸ª BeanDefinitionHolder çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹é‡Œé¢ä¹Ÿå°±æ˜¯ä¸€ä¸ª BeanDefinition çš„å®ä¾‹å’Œå®ƒçš„ beanNameã€aliases è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œæ³¨æ„ï¼Œæˆ‘ä»¬çš„å…³æ³¨ç‚¹å§‹ç»ˆåœ¨ BeanDefinition ä¸Šï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanDefinitionHolder</span> <span class="token keyword">implements</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">;</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åæˆ‘ä»¬å‡†å¤‡æ³¨å†Œè¿™ä¸ª BeanDefinitionï¼Œæœ€åï¼ŒæŠŠè¿™ä¸ªæ³¨å†Œäº‹ä»¶å‘é€å‡ºå»ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¼€å§‹è¯´è¯´æ³¨å†Œ Bean å§ã€‚</p>
<h5 id="æ³¨å†Œ-Bean"><a href="#æ³¨å†Œ-Bean" class="headerlink" title="æ³¨å†Œ Bean"></a>æ³¨å†Œ Bean</h5><p>// BeanDefinitionReaderUtils 143</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>
      <span class="token class-name">BeanDefinitionHolder</span> definitionHolder<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

   <span class="token class-name">String</span> beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// æ³¨å†Œè¿™ä¸ª Bean</span>
   registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¦‚æœè¿˜æœ‰åˆ«åçš„è¯ï¼Œä¹Ÿè¦æ ¹æ®åˆ«åå…¨éƒ¨æ³¨å†Œä¸€éï¼Œä¸ç„¶æ ¹æ®åˆ«åå°±ä¼šæ‰¾ä¸åˆ° Bean äº†</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// alias -&gt; beanName ä¿å­˜å®ƒä»¬çš„åˆ«åä¿¡æ¯ï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ª map ä¿å­˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼Œ</span>
         <span class="token comment">// è·å–çš„æ—¶å€™ï¼Œä¼šå…ˆå°† alias è½¬æ¢ä¸º beanNameï¼Œç„¶åå†æŸ¥æ‰¾</span>
         registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ«åæ³¨å†Œçš„æ”¾ä¸€è¾¹ï¼Œæ¯•ç«Ÿå®ƒå¾ˆç®€å•ï¼Œæˆ‘ä»¬çœ‹çœ‹æ€ä¹ˆæ³¨å†Œ Beanã€‚</p>
<p>// DefaultListableBeanFactory 793</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>

   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">,</span> <span class="token string">"BeanDefinition must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDefinition <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// old? è¿˜è®°å¾— â€œå…è®¸ bean è¦†ç›–â€ è¿™ä¸ªé…ç½®å—ï¼ŸallowBeanDefinitionOverriding</span>
   <span class="token class-name">BeanDefinition</span> oldBeanDefinition<span class="token punctuation">;</span>
  
   <span class="token comment">// ä¹‹åä¼šçœ‹åˆ°ï¼Œæ‰€æœ‰çš„ Bean æ³¨å†Œåä¼šæ”¾å…¥è¿™ä¸ª beanDefinitionMap ä¸­</span>
   oldBeanDefinition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// å¤„ç†é‡å¤åç§°çš„ Bean å®šä¹‰çš„æƒ…å†µ</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¦‚æœä¸å…è®¸è¦†ç›–çš„è¯ï¼ŒæŠ›å¼‚å¸¸</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨æ¡†æ¶å®šä¹‰çš„ Bean è¦†ç›–ç”¨æˆ·è‡ªå®šä¹‰çš„ Bean </span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨æ–°çš„ Bean è¦†ç›–æ—§çš„ Bean</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// log...ç”¨åŒç­‰çš„ Bean è¦†ç›–æ—§çš„ Beanï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ equals æ–¹æ³•è¿”å› true çš„ Bean</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è¦†ç›–</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å…¶ä»–çš„ Bean å¼€å§‹åˆå§‹åŒ–äº†.</span>
      <span class="token comment">// æ³¨æ„ï¼Œ"æ³¨å†ŒBean" è¿™ä¸ªåŠ¨ä½œç»“æŸï¼ŒBean ä¾ç„¶è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬åé¢ä¼šæœ‰å¤§ç¯‡å¹…è¯´åˆå§‹åŒ–è¿‡ç¨‹ï¼Œ</span>
      <span class="token comment">// åœ¨ Spring å®¹å™¨å¯åŠ¨çš„æœ€åï¼Œä¼š é¢„åˆå§‹åŒ– æ‰€æœ‰çš„ singleton beans</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            updatedDefinitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            updatedDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedSingletons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
               updatedSingletons<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames <span class="token operator">=</span> updatedSingletons<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// æœ€æ­£å¸¸çš„åº”è¯¥æ˜¯è¿›åˆ°è¿™ä¸ªåˆ†æ”¯ã€‚</span>
        
         <span class="token comment">// å°† BeanDefinition æ”¾åˆ°è¿™ä¸ª map ä¸­ï¼Œè¿™ä¸ª map ä¿å­˜äº†æ‰€æœ‰çš„ BeanDefinition</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è¿™æ˜¯ä¸ª ArrayListï¼Œæ‰€ä»¥ä¼šæŒ‰ç…§ bean é…ç½®çš„é¡ºåºä¿å­˜æ¯ä¸€ä¸ªæ³¨å†Œçš„ Bean çš„åå­—</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è¿™æ˜¯ä¸ª LinkedHashSetï¼Œä»£è¡¨çš„æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„ singleton beanï¼Œ</span>
         <span class="token comment">// æ³¨æ„è¿™é‡Œæ˜¯ remove æ–¹æ³•ï¼Œåˆ°è¿™é‡Œçš„ Bean å½“ç„¶ä¸æ˜¯æ‰‹åŠ¨æ³¨å†Œçš„</span>
         <span class="token comment">// æ‰‹åŠ¨æŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å†Œçš„ bean ï¼š</span>
         <span class="token comment">//     registerSingleton(String beanName, Object singletonObject)</span>
         <span class="token comment">// è¿™ä¸æ˜¯é‡ç‚¹ï¼Œè§£é‡Šåªæ˜¯ä¸ºäº†ä¸è®©å¤§å®¶ç–‘æƒ‘ã€‚Spring ä¼šåœ¨åé¢"æ‰‹åŠ¨"æ³¨å†Œä¸€äº› Beanï¼Œ</span>
         <span class="token comment">// å¦‚ "environment"ã€"systemProperties" ç­‰ beanï¼Œæˆ‘ä»¬è‡ªå·±ä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶æ³¨å†Œ Bean åˆ°å®¹å™¨ä¸­çš„</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// è¿™ä¸ªä¸é‡è¦ï¼Œåœ¨é¢„åˆå§‹åŒ–çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œä¸å¿…ç®¡å®ƒã€‚</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°è¿™é‡Œå·²ç»åˆå§‹åŒ–äº† Bean å®¹å™¨ï¼Œ<code>&lt;bean /&gt;</code> é…ç½®ä¹Ÿç›¸åº”çš„è½¬æ¢ä¸ºäº†ä¸€ä¸ªä¸ª BeanDefinitionï¼Œç„¶åæ³¨å†Œäº†å„ä¸ª BeanDefinition åˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ä¸”å‘é€äº†æ³¨å†Œäº‹ä»¶ã€‚</p>
<p>â€”â€”â€” åˆ†å‰²çº¿ â€”â€”â€”</p>
<p>åˆ°è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†æ°´å²­ï¼Œå‰é¢çš„å†…å®¹éƒ½è¿˜ç®—æ¯”è¾ƒç®€å•ï¼Œä¸è¿‡åº”è¯¥ä¹Ÿæ¯”è¾ƒç¹çï¼Œå¤§å®¶è¦æ¸…æ¥šåœ°çŸ¥é“å‰é¢éƒ½åšäº†å“ªäº›äº‹æƒ…ã€‚</p>
<h3 id="â‘¢-Bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå"><a href="#â‘¢-Bean-å®¹å™¨å®ä¾‹åŒ–å®Œæˆå" class="headerlink" title="â‘¢ Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå"></a>â‘¢ Bean å®¹å™¨å®ä¾‹åŒ–å®Œæˆå</h3><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å›åˆ° refresh() æ–¹æ³•ï¼Œæˆ‘é‡æ–°è´´äº†ä¸€éä»£ç ï¼Œçœ‹çœ‹æˆ‘ä»¬è¯´åˆ°å“ªäº†ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬æ‰è¯´å®Œ obtainFreshBeanFactory() æ–¹æ³•ã€‚</p>
<p>è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œè¿™é‡Œå¼€å§‹å¤§å¹…ç¼©å‡æ‰æ²¡å¿…è¦è¯¦ç»†ä»‹ç»çš„éƒ¨åˆ†ï¼Œå¤§å®¶ç›´æ¥çœ‹ä¸‹é¢çš„ä»£ç ä¸­çš„æ³¨é‡Šå°±å¥½äº†ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ¥ä¸ªé”ï¼Œä¸ç„¶ refresh() è¿˜æ²¡ç»“æŸï¼Œä½ åˆæ¥ä¸ªå¯åŠ¨æˆ–é”€æ¯å®¹å™¨çš„æ“ä½œï¼Œé‚£ä¸å°±ä¹±å¥—äº†å˜›</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// å‡†å¤‡å·¥ä½œï¼Œè®°å½•ä¸‹å®¹å™¨çš„å¯åŠ¨æ—¶é—´ã€æ ‡è®°â€œå·²å¯åŠ¨â€çŠ¶æ€ã€å¤„ç†é…ç½®æ–‡ä»¶ä¸­çš„å ä½ç¬¦</span>
      <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token comment">// è¿™æ­¥æ¯”è¾ƒå…³é”®ï¼Œè¿™æ­¥å®Œæˆåï¼Œé…ç½®æ–‡ä»¶å°±ä¼šè§£ææˆä¸€ä¸ªä¸ª Bean å®šä¹‰ï¼Œæ³¨å†Œåˆ° BeanFactory ä¸­ï¼Œ</span>
      <span class="token comment">// å½“ç„¶ï¼Œè¿™é‡Œè¯´çš„ Bean è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåªæ˜¯é…ç½®ä¿¡æ¯éƒ½æå–å‡ºæ¥äº†ï¼Œ</span>
      <span class="token comment">// æ³¨å†Œä¹Ÿåªæ˜¯å°†è¿™äº›ä¿¡æ¯éƒ½ä¿å­˜åˆ°äº†æ³¨å†Œä¸­å¿ƒ(è¯´åˆ°åº•æ ¸å¿ƒæ˜¯ä¸€ä¸ª beanName-&gt; beanDefinition çš„ map)</span>
      <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæ·»åŠ å‡ ä¸ª BeanPostProcessorï¼Œæ‰‹åŠ¨æ³¨å†Œå‡ ä¸ªç‰¹æ®Šçš„ bean</span>
      <span class="token comment">// è¿™å—å¾…ä¼šä¼šå±•å¼€è¯´</span>
      <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token comment">// ã€è¿™é‡Œéœ€è¦çŸ¥é“ BeanFactoryPostProcessor è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼ŒBean å¦‚æœå®ç°äº†æ­¤æ¥å£ï¼Œ</span>
         <span class="token comment">// é‚£ä¹ˆåœ¨å®¹å™¨åˆå§‹åŒ–ä»¥åï¼ŒSpring ä¼šè´Ÿè´£è°ƒç”¨é‡Œé¢çš„ postProcessBeanFactory æ–¹æ³•ã€‚ã€‘</span>
        
         <span class="token comment">// è¿™é‡Œæ˜¯æä¾›ç»™å­ç±»çš„æ‰©å±•ç‚¹ï¼Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ Bean éƒ½åŠ è½½ã€æ³¨å†Œå®Œæˆäº†ï¼Œä½†æ˜¯éƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™æ­¥çš„æ—¶å€™æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„ BeanFactoryPostProcessor çš„å®ç°ç±»æˆ–åšç‚¹ä»€ä¹ˆäº‹</span>
         <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// è°ƒç”¨ BeanFactoryPostProcessor å„ä¸ªå®ç°ç±»çš„ postProcessBeanFactory(factory) å›è°ƒæ–¹æ³•</span>
         <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>          
         
          

         <span class="token comment">// æ³¨å†Œ BeanPostProcessor çš„å®ç°ç±»ï¼Œæ³¨æ„çœ‹å’Œ BeanFactoryPostProcessor çš„åŒºåˆ«</span>
         <span class="token comment">// æ­¤æ¥å£ä¸¤ä¸ªæ–¹æ³•: postProcessBeforeInitialization å’Œ postProcessAfterInitialization</span>
         <span class="token comment">// ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«åœ¨ Bean åˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åå¾—åˆ°æ‰§è¡Œã€‚è¿™é‡Œä»…ä»…æ˜¯æ³¨å†Œï¼Œä¹‹åä¼šçœ‹åˆ°å›è°ƒè¿™ä¸¤æ–¹æ³•çš„æ—¶æœº</span>
         <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„ MessageSourceï¼Œå›½é™…åŒ–è¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ï¼Œä¸ç„¶æ²¡å®Œæ²¡äº†äº†</span>
         <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// åˆå§‹åŒ–å½“å‰ ApplicationContext çš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œè¿™é‡Œä¹Ÿä¸å±•å¼€äº†</span>
         <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// ä»æ–¹æ³•åå°±å¯ä»¥çŸ¥é“ï¼Œå…¸å‹çš„æ¨¡æ¿æ–¹æ³•(é’©å­æ–¹æ³•)ï¼Œä¸å±•å¼€è¯´</span>
         <span class="token comment">// å…·ä½“çš„å­ç±»å¯ä»¥åœ¨è¿™é‡Œåˆå§‹åŒ–ä¸€äº›ç‰¹æ®Šçš„ Beanï¼ˆåœ¨åˆå§‹åŒ– singleton beans ä¹‹å‰ï¼‰</span>
         <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œç›‘å¬å™¨éœ€è¦å®ç° ApplicationListener æ¥å£ã€‚è¿™ä¹Ÿä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œè¿‡</span>
         <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// é‡ç‚¹ï¼Œé‡ç‚¹ï¼Œé‡ç‚¹</span>
         <span class="token comment">// åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</span>
         <span class="token comment">//ï¼ˆlazy-init çš„é™¤å¤–ï¼‰</span>
         <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æœ€åï¼Œå¹¿æ’­äº‹ä»¶ï¼ŒApplicationContext åˆå§‹åŒ–å®Œæˆï¼Œä¸å±•å¼€</span>
         <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span>
                  <span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// Destroy already created singletons to avoid dangling resources.</span>
         <span class="token comment">// é”€æ¯å·²ç»åˆå§‹åŒ–çš„ singleton çš„ Beansï¼Œä»¥å…æœ‰äº› bean ä¼šä¸€ç›´å ç”¨èµ„æº</span>
         <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// Reset 'active' flag.</span>
         <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// æŠŠå¼‚å¸¸å¾€å¤–æŠ›</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">finally</span> <span class="token punctuation">{</span>
         <span class="token comment">// Reset common introspection caches in Spring's core, since we</span>
         <span class="token comment">// might not ever need metadata for singleton beans anymore...</span>
         <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="â‘£-å‡†å¤‡-Bean-å®¹å™¨-prepareBeanFactory"><a href="#â‘£-å‡†å¤‡-Bean-å®¹å™¨-prepareBeanFactory" class="headerlink" title="â‘£ å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory"></a>â‘£ å‡†å¤‡ Bean å®¹å™¨: prepareBeanFactory</h3><p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒSpring æŠŠæˆ‘ä»¬åœ¨ xml é…ç½®çš„ bean éƒ½æ³¨å†Œä»¥åï¼Œä¼šâ€æ‰‹åŠ¨â€æ³¨å†Œä¸€äº›ç‰¹æ®Šçš„ beanã€‚</p>
<p>è¿™é‡Œç®€å•ä»‹ç»ä¸‹ prepareBeanFactory(factory) æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Configure the factory's standard context characteristics,
 * such as the context's ClassLoader and post-processors.
 * @param beanFactory the BeanFactory to configure
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// è®¾ç½® BeanFactory çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬çŸ¥é“ BeanFactory éœ€è¦åŠ è½½ç±»ï¼Œä¹Ÿå°±éœ€è¦ç±»åŠ è½½å™¨ï¼Œ</span>
   <span class="token comment">// è¿™é‡Œè®¾ç½®ä¸ºåŠ è½½å½“å‰ ApplicationContext ç±»çš„ç±»åŠ è½½å™¨</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
   <span class="token comment">// è®¾ç½® BeanExpressionResolver</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setBeanExpressionResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StandardBeanExpressionResolver</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// </span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addPropertyEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResourceEditorRegistrar</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ·»åŠ ä¸€ä¸ª BeanPostProcessorï¼Œè¿™ä¸ª processor æ¯”è¾ƒç®€å•ï¼š</span>
   <span class="token comment">// å®ç°äº† Aware æ¥å£çš„ beans åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ª processor è´Ÿè´£å›è°ƒï¼Œ</span>
   <span class="token comment">// è¿™ä¸ªæˆ‘ä»¬å¾ˆå¸¸ç”¨ï¼Œå¦‚æˆ‘ä»¬ä¼šä¸ºäº†è·å– ApplicationContext è€Œ implement ApplicationContextAware</span>
   <span class="token comment">// æ³¨æ„ï¼šå®ƒä¸ä»…ä»…å›è°ƒ ApplicationContextAwareï¼Œ</span>
   <span class="token comment">//   è¿˜ä¼šè´Ÿè´£å›è°ƒ EnvironmentAwareã€ResourceLoaderAware ç­‰ï¼Œçœ‹ä¸‹æºç å°±æ¸…æ¥šäº†</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// ä¸‹é¢å‡ è¡Œçš„æ„æ€å°±æ˜¯ï¼Œå¦‚æœæŸä¸ª bean ä¾èµ–äºä»¥ä¸‹å‡ ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œåœ¨è‡ªåŠ¨è£…é…çš„æ—¶å€™å¿½ç•¥å®ƒä»¬ï¼Œ</span>
   <span class="token comment">// Spring ä¼šé€šè¿‡å…¶ä»–æ–¹å¼æ¥å¤„ç†è¿™äº›ä¾èµ–ã€‚</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EnvironmentAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">EmbeddedValueResolverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoaderAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisherAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">MessageSourceAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">ignoreDependencyInterface</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * ä¸‹é¢å‡ è¡Œå°±æ˜¯ä¸ºç‰¹æ®Šçš„å‡ ä¸ª bean èµ‹å€¼ï¼Œå¦‚æœæœ‰ bean ä¾èµ–äº†ä»¥ä¸‹å‡ ä¸ªï¼Œä¼šæ³¨å…¥è¿™è¾¹ç›¸åº”çš„å€¼ï¼Œ
    * ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œ"å½“å‰ ApplicationContext æŒæœ‰ä¸€ä¸ª BeanFactory"ï¼Œè¿™é‡Œè§£é‡Šäº†ç¬¬ä¸€è¡Œã€‚
    * ApplicationContext è¿˜ç»§æ‰¿äº† ResourceLoaderã€ApplicationEventPublisherã€MessageSource
    * æ‰€ä»¥å¯¹äºè¿™å‡ ä¸ªä¾èµ–ï¼Œå¯ä»¥èµ‹å€¼ä¸º thisï¼Œæ³¨æ„ this æ˜¯ä¸€ä¸ª ApplicationContext
    * é‚£è¿™é‡Œæ€ä¹ˆæ²¡çœ‹åˆ°ä¸º MessageSource èµ‹å€¼å‘¢ï¼Ÿé‚£æ˜¯å› ä¸º MessageSource è¢«æ³¨å†Œæˆä¸ºäº†ä¸€ä¸ªæ™®é€šçš„ bean
    */</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ResourceLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">registerResolvableDependency</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿™ä¸ª BeanPostProcessor ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ bean å®ä¾‹åŒ–åï¼Œå¦‚æœæ˜¯ ApplicationListener çš„å­ç±»ï¼Œ</span>
   <span class="token comment">// é‚£ä¹ˆå°†å…¶æ·»åŠ åˆ° listener åˆ—è¡¨ä¸­ï¼Œå¯ä»¥ç†è§£æˆï¼šæ³¨å†Œ äº‹ä»¶ç›‘å¬å™¨</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApplicationListenerDetector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// è¿™é‡Œæ¶‰åŠåˆ°ç‰¹æ®Šçš„ beanï¼Œåä¸ºï¼šloadTimeWeaverï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ï¼Œå¿½ç•¥å®ƒ</span>
   <span class="token comment">// tips: ltw æ˜¯ AspectJ çš„æ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯åœ¨è¿è¡ŒæœŸè¿›è¡Œç»‡å…¥ï¼Œè¿™ä¸ªå’Œ Spring AOP ä¸ä¸€æ ·ï¼Œ</span>
   <span class="token comment">//    æ„Ÿå…´è¶£çš„è¯»è€…è¯·å‚è€ƒæˆ‘å†™çš„å…³äº AspectJ çš„å¦ä¸€ç¯‡æ–‡ç«  https://www.javadoop.com/post/aspectj</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>LOAD_TIME_WEAVER_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoadTimeWeaverAwareProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Set a temporary ClassLoader for type matching.</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextTypeMatchClassLoader</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * ä»ä¸‹é¢å‡ è¡Œä»£ç æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼ŒSpring å¾€å¾€å¾ˆ "æ™ºèƒ½" å°±æ˜¯å› ä¸ºå®ƒä¼šå¸®æˆ‘ä»¬é»˜è®¤æ³¨å†Œä¸€äº›æœ‰ç”¨çš„ beanï¼Œ
    * æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è¦†ç›–
    */</span>
  
   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ "environment" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>ENVIRONMENT_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ "systemProperties" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>SYSTEM_PROPERTIES_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// å¦‚æœæ²¡æœ‰å®šä¹‰ "systemEnvironment" è¿™ä¸ª beanï¼Œé‚£ä¹ˆ Spring ä¼š "æ‰‹åŠ¨" æ³¨å†Œä¸€ä¸ª</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsLocalBean</span><span class="token punctuation">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>SYSTEM_ENVIRONMENT_BEAN_NAME<span class="token punctuation">,</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ä¸Šé¢è¿™å—ä»£ç ä¸­ï¼ŒSpring å¯¹ä¸€äº›ç‰¹æ®Šçš„ bean è¿›è¡Œäº†å¤„ç†ï¼Œè¯»è€…å¦‚æœæš‚æ—¶è¿˜ä¸èƒ½æ¶ˆåŒ–å®ƒä»¬ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p>
<h3 id="â‘¤-åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans"><a href="#â‘¤-åˆå§‹åŒ–æ‰€æœ‰çš„-singleton-beans" class="headerlink" title="â‘¤ åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans"></a>â‘¤ åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beans</h3><p>æˆ‘ä»¬çš„é‡ç‚¹å½“ç„¶æ˜¯ <code>finishBeanFactoryInitialization(beanFactory);</code> è¿™ä¸ªå·¨å¤´äº†ï¼Œè¿™é‡Œä¼šè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>
<p>æ³¨æ„ï¼Œåé¢çš„æè¿°ä¸­ï¼Œæˆ‘éƒ½ä¼šä½¿ç”¨<strong>åˆå§‹åŒ–</strong>æˆ–<strong>é¢„åˆå§‹åŒ–</strong>æ¥ä»£è¡¨è¿™ä¸ªé˜¶æ®µï¼ŒSpring ä¼šåœ¨è¿™ä¸ªé˜¶æ®µå®Œæˆæ‰€æœ‰çš„ singleton beans çš„å®ä¾‹åŒ–ã€‚</p>
<p>æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåº”è¯¥è¯´ BeanFactory å·²ç»åˆ›å»ºå®Œæˆï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ Bean éƒ½å·²ç»åˆå§‹åŒ–å¹¶ä¸”å…¶ä¸­çš„ postProcessBeanFactory(factory) æ–¹æ³•å·²ç»å¾—åˆ°å›è°ƒæ‰§è¡Œäº†ã€‚è€Œä¸” Spring å·²ç»â€œæ‰‹åŠ¨â€æ³¨å†Œäº†ä¸€äº›ç‰¹æ®Šçš„ Beanï¼Œå¦‚ <code>environment</code>ã€<code>systemProperties</code> ç­‰ã€‚</p>
<p>å‰©ä¸‹çš„å°±æ˜¯åˆå§‹åŒ– singleton beans äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®ƒä»¬æ˜¯å•ä¾‹çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ‡’åŠ è½½ï¼Œé‚£ä¹ˆ Spring ä¼šåœ¨æ¥ä¸‹æ¥åˆå§‹åŒ–æ‰€æœ‰çš„ singleton beansã€‚</p>
<p>// AbstractApplicationContext.java 834</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// åˆå§‹åŒ–å‰©ä½™çš„ singleton beans</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token comment">// é¦–å…ˆï¼Œåˆå§‹åŒ–åå­—ä¸º conversionService çš„ Beanã€‚æœ¬ç€é€ä½›é€åˆ°è¥¿çš„ç²¾ç¥ï¼Œæˆ‘åœ¨é™„å½•ä¸­ç®€å•ä»‹ç»äº†ä¸€ä¸‹ ConversionServiceï¼Œå› ä¸ºè¿™å®åœ¨å¤ªå®ç”¨äº†</span>
   <span class="token comment">// ä»€ä¹ˆï¼Œçœ‹ä»£ç è¿™é‡Œæ²¡æœ‰åˆå§‹åŒ– Bean å•Šï¼</span>
   <span class="token comment">// æ³¨æ„äº†ï¼Œåˆå§‹åŒ–çš„åŠ¨ä½œåŒ…è£…åœ¨ beanFactory.getBean(...) ä¸­ï¼Œè¿™é‡Œå…ˆä¸è¯´ç»†èŠ‚ï¼Œå…ˆå¾€ä¸‹çœ‹å§</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
         beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span>
            beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>CONVERSION_SERVICE_BEAN_NAME<span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Register a default embedded value resolver if no bean post-processor</span>
   <span class="token comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span>
   <span class="token comment">// at this point, primarily for resolution in annotation attribute values.</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">hasEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      beanFactory<span class="token punctuation">.</span><span class="token function">addEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringValueResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolveStringValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> strVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>strVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å…ˆåˆå§‹åŒ– LoadTimeWeaverAware ç±»å‹çš„ Bean</span>
   <span class="token comment">// ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œè¿™æ˜¯ AspectJ ç›¸å…³çš„å†…å®¹ï¼Œæ”¾å¿ƒè·³è¿‡å§</span>
   <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> weaverAwareNames <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanNamesForType</span><span class="token punctuation">(</span><span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> weaverAwareName <span class="token operator">:</span> weaverAwareNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getBean</span><span class="token punctuation">(</span>weaverAwareName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Stop using the temporary ClassLoader for type matching.</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ²¡ä»€ä¹ˆåˆ«çš„ç›®çš„ï¼Œå› ä¸ºåˆ°è¿™ä¸€æ­¥çš„æ—¶å€™ï¼ŒSpring å·²ç»å¼€å§‹é¢„åˆå§‹åŒ– singleton beans äº†ï¼Œ</span>
   <span class="token comment">// è‚¯å®šä¸å¸Œæœ›è¿™ä¸ªæ—¶å€™è¿˜å‡ºç° bean å®šä¹‰è§£æã€åŠ è½½ã€æ³¨å†Œã€‚</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// å¼€å§‹åˆå§‹åŒ–</span>
   beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä»ä¸Šé¢æœ€åä¸€è¡Œå¾€é‡Œçœ‹ï¼Œæˆ‘ä»¬å°±åˆå›åˆ° DefaultListableBeanFactory è¿™ä¸ªç±»äº†ï¼Œè¿™ä¸ªç±»å¤§å®¶åº”è¯¥éƒ½ä¸é™Œç”Ÿäº†å§ã€‚</p>
<h4 id="preInstantiateSingletons"><a href="#preInstantiateSingletons" class="headerlink" title="preInstantiateSingletons"></a>preInstantiateSingletons</h4><p>// DefaultListableBeanFactory 728</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Pre-instantiating singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// this.beanDefinitionNames ä¿å­˜äº†æ‰€æœ‰çš„ beanNames</span>
   <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ä¸‹é¢è¿™ä¸ªå¾ªç¯ï¼Œè§¦å‘æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans çš„åˆå§‹åŒ–æ“ä½œ</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     
      <span class="token comment">// åˆå¹¶çˆ¶ Bean ä¸­çš„é…ç½®ï¼Œæ³¨æ„ &lt;bean id="" class="" parent="" /&gt; ä¸­çš„ parentï¼Œç”¨çš„ä¸å¤šå§ï¼Œ</span>
      <span class="token comment">// è€ƒè™‘åˆ°è¿™å¯èƒ½ä¼šå½±å“å¤§å®¶çš„ç†è§£ï¼Œæˆ‘åœ¨é™„å½•ä¸­è§£é‡Šäº†ä¸€ä¸‹ "Bean ç»§æ‰¿"ï¼Œä¸äº†è§£çš„è¯·åˆ°é™„å½•ä¸­çœ‹ä¸€ä¸‹</span>
      <span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token comment">// éæŠ½è±¡ã€éæ‡’åŠ è½½çš„ singletonsã€‚å¦‚æœé…ç½®äº† 'abstract = true'ï¼Œé‚£æ˜¯ä¸éœ€è¦åˆå§‹åŒ–çš„</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¤„ç† FactoryBean(è¯»è€…å¦‚æœä¸ç†Ÿæ‚‰ FactoryBeanï¼Œè¯·ç§»æ­¥é™„å½•åŒºäº†è§£)</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// FactoryBean çš„è¯ï¼Œåœ¨ beanName å‰é¢åŠ ä¸Š â€˜&amp;â€™ ç¬¦å·ã€‚å†è°ƒç”¨ getBeanï¼ŒgetBean æ–¹æ³•åˆ«æ€¥</span>
            <span class="token keyword">final</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token function">getBean</span><span class="token punctuation">(</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­å½“å‰ FactoryBean æ˜¯å¦æ˜¯ SmartFactoryBean çš„å®ç°ï¼Œæ­¤å¤„å¿½ç•¥ï¼Œç›´æ¥è·³è¿‡</span>
            <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token annotation punctuation">@Override</span>
                  <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
               isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>
                     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               
               <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¯¹äºæ™®é€šçš„ Beanï¼Œåªè¦è°ƒç”¨ getBean(beanName) è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è¿›è¡Œåˆå§‹åŒ–äº†</span>
            <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ°è¿™é‡Œè¯´æ˜æ‰€æœ‰çš„éæ‡’åŠ è½½çš„ singleton beans å·²ç»å®Œæˆäº†åˆå§‹åŒ–</span>
   <span class="token comment">// å¦‚æœæˆ‘ä»¬å®šä¹‰çš„ bean æ˜¯å®ç°äº† SmartInitializingSingleton æ¥å£çš„ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå¾—åˆ°å›è°ƒï¼Œå¿½ç•¥</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">final</span> <span class="token class-name">SmartInitializingSingleton</span> smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token annotation punctuation">@Override</span>
               <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±è¿›å…¥åˆ° getBean(beanName) æ–¹æ³•äº†ï¼Œè¿™ä¸ªæ–¹æ³•æˆ‘ä»¬ç»å¸¸ç”¨æ¥ä» BeanFactory ä¸­è·å–ä¸€ä¸ª Beanï¼Œè€Œåˆå§‹åŒ–çš„è¿‡ç¨‹ä¹Ÿå°è£…åˆ°äº†è¿™ä¸ªæ–¹æ³•é‡Œã€‚</p>
<h4 id="getBean"><a href="#getBean" class="headerlink" title="getBean"></a>getBean</h4><p>åœ¨ç»§ç»­å‰è¿›ä¹‹å‰ï¼Œè¯»è€…åº”è¯¥å…·å¤‡ FactoryBean çš„çŸ¥è¯†ï¼Œå¦‚æœè¯»è€…è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·ç§»æ­¥é™„å½•éƒ¨åˆ†äº†è§£ FactoryBeanã€‚</p>
<p>// AbstractBeanFactory 196</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// æˆ‘ä»¬åœ¨å‰–æåˆå§‹åŒ– Bean çš„è¿‡ç¨‹ï¼Œä½†æ˜¯ getBean æ–¹æ³•æˆ‘ä»¬ç»å¸¸æ˜¯ç”¨æ¥ä»å®¹å™¨ä¸­è·å– Bean ç”¨çš„ï¼Œæ³¨æ„åˆ‡æ¢æ€è·¯ï¼Œ</span>
<span class="token comment">// å·²ç»åˆå§‹åŒ–è¿‡äº†å°±ä»å®¹å™¨ä¸­ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±å…ˆåˆå§‹åŒ–å†è¿”å›</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span>
      <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
   <span class="token comment">// è·å–ä¸€ä¸ª â€œæ­£ç»Ÿçš„â€ beanNameï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªæ˜¯å‰é¢è¯´çš„ FactoryBean(å‰é¢å¸¦ â€˜&amp;â€™)ï¼Œ</span>
   <span class="token comment">// ä¸€ä¸ªæ˜¯åˆ«åé—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ getBeanï¼Œè·å– Bean ç”¨çš„ï¼Œä½ è¦æ˜¯ä¼ ä¸€ä¸ªåˆ«åè¿›æ¥ï¼Œæ˜¯å®Œå…¨å¯ä»¥çš„</span>
   <span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// æ³¨æ„è·Ÿç€è¿™ä¸ªï¼Œè¿™ä¸ªæ˜¯è¿”å›å€¼</span>
   <span class="token class-name">Object</span> bean<span class="token punctuation">;</span> 

   <span class="token comment">// æ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯å·²ç»åˆ›å»ºè¿‡äº†</span>
   <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
   <span class="token comment">// è¿™é‡Œè¯´ä¸‹ args å‘—ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸€ç‚¹ä¸é‡è¦ã€‚å‰é¢æˆ‘ä»¬ä¸€è·¯è¿›æ¥çš„æ—¶å€™éƒ½æ˜¯ getBean(beanName)ï¼Œ</span>
   <span class="token comment">// æ‰€ä»¥ args ä¼ å‚å…¶å®æ˜¯ null çš„ï¼Œä½†æ˜¯å¦‚æœ args ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è°ƒç”¨æ–¹ä¸æ˜¯å¸Œæœ›è·å– Beanï¼Œè€Œæ˜¯åˆ›å»º Bean</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼šå¦‚æœæ˜¯æ™®é€š Bean çš„è¯ï¼Œç›´æ¥è¿”å› sharedInstanceï¼Œ</span>
      <span class="token comment">// å¦‚æœæ˜¯ FactoryBean çš„è¯ï¼Œè¿”å›å®ƒåˆ›å»ºçš„é‚£ä¸ªå®ä¾‹å¯¹è±¡</span>
      <span class="token comment">// (FactoryBean çŸ¥è¯†ï¼Œè¯»è€…è‹¥ä¸æ¸…æ¥šè¯·ç§»æ­¥é™„å½•)</span>
      bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// åˆ›å»ºè¿‡äº†æ­¤ beanName çš„ prototype ç±»å‹çš„ beanï¼Œé‚£ä¹ˆæŠ›å¼‚å¸¸ï¼Œ</span>
         <span class="token comment">// å¾€å¾€æ˜¯å› ä¸ºé™·å…¥äº†å¾ªç¯å¼•ç”¨</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ£€æŸ¥ä¸€ä¸‹è¿™ä¸ª BeanDefinition åœ¨å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨</span>
      <span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// å¦‚æœå½“å‰å®¹å™¨ä¸å­˜åœ¨è¿™ä¸ª BeanDefinitionï¼Œè¯•è¯•çˆ¶å®¹å™¨ä¸­æœ‰æ²¡æœ‰</span>
         <span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// No args -&gt; delegate to standard getBean method.</span>
            <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// typeCheckOnly ä¸º falseï¼Œå°†å½“å‰ beanName æ”¾å…¥ä¸€ä¸ª alreadyCreated çš„ Set é›†åˆä¸­ã€‚</span>
         <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/*
       * ç¨ç¨æ€»ç»“ä¸€ä¸‹ï¼š
       * åˆ°è¿™é‡Œçš„è¯ï¼Œè¦å‡†å¤‡åˆ›å»º Bean äº†ï¼Œå¯¹äº singleton çš„ Bean æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿˜æ²¡åˆ›å»ºè¿‡æ­¤ Beanï¼›
       * å¯¹äº prototype çš„ Bean æ¥è¯´ï¼Œæœ¬æ¥å°±æ˜¯è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ Beanã€‚
       */</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// å…ˆåˆå§‹åŒ–ä¾èµ–çš„æ‰€æœ‰ Beanï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚</span>
         <span class="token comment">// æ³¨æ„ï¼Œè¿™é‡Œçš„ä¾èµ–æŒ‡çš„æ˜¯ depends-on ä¸­å®šä¹‰çš„ä¾èµ–</span>
         <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œçš„å¾ªç¯ä¾èµ–å’Œæˆ‘ä»¬å‰é¢è¯´çš„å¾ªç¯ä¾èµ–åˆä¸ä¸€æ ·ï¼Œè¿™é‡Œè‚¯å®šæ˜¯ä¸å…è®¸å‡ºç°çš„ï¼Œä¸ç„¶è¦ä¹±å¥—äº†ï¼Œè¯»è€…æƒ³ä¸€ä¸‹å°±çŸ¥é“äº†</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                        <span class="token string">"Circular depends-on relationship between '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token comment">// æ³¨å†Œä¸€ä¸‹ä¾èµ–å…³ç³»</span>
               <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹</span>
               <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// å¦‚æœæ˜¯ singleton scope çš„ï¼Œåˆ›å»º singleton çš„å®ä¾‹</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token annotation punctuation">@Override</span>
               <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                     <span class="token comment">// æ‰§è¡Œåˆ›å»º Beanï¼Œè¯¦æƒ…åé¢å†è¯´</span>
                     <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// å¦‚æœæ˜¯ prototype scope çš„ï¼Œåˆ›å»º prototype çš„å®ä¾‹</span>
         <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// It's a prototype -&gt; create a new instance.</span>
            <span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// æ‰§è¡Œåˆ›å»º Bean</span>
               prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span> <span class="token punctuation">{</span>
               <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// å¦‚æœä¸æ˜¯ singleton å’Œ prototype çš„è¯ï¼Œéœ€è¦å§”æ‰˜ç»™ç›¸åº”çš„å®ç°ç±»æ¥å¤„ç†</span>
         <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token annotation punctuation">@Override</span>
                  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
                     <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// æ‰§è¡Œåˆ›å»º Bean</span>
                        <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                     <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span>
               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                     <span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span>
                     <span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span>
                     ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// æœ€åï¼Œæ£€æŸ¥ä¸€ä¸‹ç±»å‹å¯¹ä¸å¯¹ï¼Œä¸å¯¹çš„è¯å°±æŠ›å¼‚å¸¸ï¼Œå¯¹çš„è¯å°±è¿”å›äº†</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> bean <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Failed to convert bean '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' to required type '"</span> <span class="token operator">+</span>
                  <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¤§å®¶åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œæ¥ä¸‹æ¥å½“ç„¶æ˜¯åˆ†æ createBean æ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç¬¬ä¸‰ä¸ªå‚æ•° args æ•°ç»„ä»£è¡¨åˆ›å»ºå®ä¾‹éœ€è¦çš„å‚æ•°ï¼Œä¸å°±æ˜¯ç»™æ„é€ æ–¹æ³•ç”¨çš„å‚æ•°ï¼Œæˆ–è€…æ˜¯å·¥å‚ Bean çš„å‚æ•°å˜›ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œåœ¨æˆ‘ä»¬çš„åˆå§‹åŒ–é˜¶æ®µï¼Œargs æ˜¯ nullã€‚</p>
<p>è¿™å›æˆ‘ä»¬è¦åˆ°ä¸€ä¸ªæ–°çš„ç±»äº† AbstractAutowireCapableBeanFactoryï¼Œçœ‹ç±»åï¼ŒAutowireCapableï¼Ÿç±»åæ˜¯ä¸æ˜¯ä¹Ÿè¯´æ˜äº†ç‚¹é—®é¢˜äº†ã€‚</p>
<p>ä¸»è¦æ˜¯ä¸ºäº†ä»¥ä¸‹åœºæ™¯ï¼Œé‡‡ç”¨ @Autowired æ³¨è§£æ³¨å…¥å±æ€§å€¼ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
  
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messageService<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»¥ä¸Šè¿™ç§å±äºæ··ç”¨äº† xml å’Œ æ³¨è§£ ä¸¤ç§æ–¹å¼çš„é…ç½®æ–¹å¼ï¼ŒSpring ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚</p>
<p>å¥½äº†ï¼Œè¯»è€…è¦çŸ¥é“è¿™ä¹ˆå›äº‹å°±å¯ä»¥äº†ï¼Œç»§ç»­å‘å‰ã€‚</p>
<p>// AbstractAutowireCapableBeanFactory 447</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Central method of this class: creates a bean instance,
 * populates the bean instance, applies post-processors, etc.
 * @see #doCreateBean
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>

   <span class="token comment">// ç¡®ä¿ BeanDefinition ä¸­çš„ Class è¢«åŠ è½½</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å‡†å¤‡æ–¹æ³•è¦†å†™ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°ä¸€ä¸ªæ¦‚å¿µï¼šMethodOverridesï¼Œå®ƒæ¥è‡ªäº bean å®šä¹‰ä¸­çš„ &lt;lookup-method /&gt; </span>
   <span class="token comment">// å’Œ &lt;replaced-method /&gt;ï¼Œå¦‚æœè¯»è€…æ„Ÿå…´è¶£ï¼Œå›åˆ° bean è§£æçš„åœ°æ–¹çœ‹çœ‹å¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„è§£æã€‚</span>
   <span class="token comment">// æˆ‘åœ¨é™„å½•ä¸­ä¹Ÿå¯¹è¿™ä¸¤ä¸ªæ ‡ç­¾çš„ç›¸å…³çŸ¥è¯†ç‚¹è¿›è¡Œäº†ä»‹ç»ï¼Œè¯»è€…å¯ä»¥ç§»æ­¥å»çœ‹çœ‹</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beanName<span class="token punctuation">,</span> <span class="token string">"Validation of method overrides failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®© InstantiationAwareBeanPostProcessor åœ¨è¿™ä¸€æ­¥æœ‰æœºä¼šè¿”å›ä»£ç†ï¼Œ</span>
      <span class="token comment">// åœ¨ ã€ŠSpring AOP æºç åˆ†æã€‹é‚£ç¯‡æ–‡ç« ä¸­æœ‰è§£é‡Šï¼Œè¿™é‡Œå…ˆè·³è¿‡</span>
      <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> bean<span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
            <span class="token string">"BeanPostProcessor before instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// é‡å¤´æˆï¼Œåˆ›å»º bean</span>
   <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="åˆ›å»º-Bean"><a href="#åˆ›å»º-Bean" class="headerlink" title="åˆ›å»º Bean"></a>åˆ›å»º Bean</h4><p>æˆ‘ä»¬ç»§ç»­å¾€é‡Œçœ‹ doCreateBean è¿™ä¸ªæ–¹æ³•ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Actually create the specified bean. Pre-creation processing has already happened
 * at this point, e.g. checking {@code postProcessBeforeInstantiation} callbacks.
 * &lt;p&gt;Differentiates between default bean instantiation, use of a
 * factory method, and autowiring a constructor.
 * @param beanName the name of the bean
 * @param mbd the merged bean definition for the bean
 * @param args explicit arguments to use for constructor or factory method invocation
 * @return a new instance of the bean
 * @throws BeanCreationException if the bean could not be created
 * @see #instantiateBean
 * @see #instantiateUsingFactoryMethod
 * @see #autowireConstructor
 */</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

   <span class="token comment">// Instantiate the bean.</span>
   <span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¯´æ˜ä¸æ˜¯ FactoryBeanï¼Œè¿™é‡Œå®ä¾‹åŒ– Beanï¼Œè¿™é‡Œéå¸¸å…³é”®ï¼Œç»†èŠ‚ä¹‹åå†è¯´</span>
      instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// è¿™ä¸ªå°±æ˜¯ Bean é‡Œé¢çš„ æˆ‘ä»¬å®šä¹‰çš„ç±» çš„å®ä¾‹ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘ç›´æ¥æè¿°æˆ "bean å®ä¾‹"</span>
   <span class="token keyword">final</span> <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// ç±»å‹</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>

   <span class="token comment">// å»ºè®®è·³è¿‡å§ï¼Œæ¶‰åŠæ¥å£ï¼šMergedBeanDefinitionPostProcessor</span>
   <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// MergedBeanDefinitionPostProcessorï¼Œè¿™ä¸ªæˆ‘çœŸä¸å±•å¼€è¯´äº†ï¼Œç›´æ¥è·³è¿‡å§ï¼Œå¾ˆå°‘ç”¨çš„</span>
            <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                  <span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Eagerly cache singletons to be able to resolve circular references</span>
   <span class="token comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
   <span class="token comment">// ä¸‹é¢è¿™å—ä»£ç æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œä»¥åæœ‰æ—¶é—´ï¼Œæˆ‘å†å¯¹å¾ªç¯ä¾èµ–è¿™ä¸ªé—®é¢˜è¿›è¡Œè§£æå§</span>
   <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
         <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
               <span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Initialize the bean instance.</span>
   <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™ä¸€æ­¥ä¹Ÿæ˜¯éå¸¸å…³é”®çš„ï¼Œè¿™ä¸€æ­¥è´Ÿè´£å±æ€§è£…é…ï¼Œå› ä¸ºå‰é¢çš„å®ä¾‹åªæ˜¯å®ä¾‹åŒ–äº†ï¼Œå¹¶æ²¡æœ‰è®¾å€¼ï¼Œè¿™é‡Œå°±æ˜¯è®¾å€¼</span>
      <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// è¿˜è®°å¾— init-method å—ï¼Ÿè¿˜æœ‰ InitializingBean æ¥å£ï¼Ÿè¿˜æœ‰ BeanPostProcessor æ¥å£ï¼Ÿ</span>
         <span class="token comment">// è¿™é‡Œå°±æ˜¯å¤„ç† bean åˆå§‹åŒ–å®Œæˆåçš„å„ç§å›è°ƒ</span>
         exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
               mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Initialization of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// </span>
      <span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                     <span class="token string">"Bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' has been injected into other beans ["</span> <span class="token operator">+</span>
                     <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span>
                     <span class="token string">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="token operator">+</span>
                     <span class="token string">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="token operator">+</span>
                     <span class="token string">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="token operator">+</span>
                     <span class="token string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Register bean as disposable.</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº† doCreateBean æ–¹æ³•ï¼Œæ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å·²ç»è¯´å®Œäº†æ•´ä¸ªåˆå§‹åŒ–æµç¨‹ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‘ doCreateBean ä¸­çš„ä¸‰ä¸ªç»†èŠ‚å‡ºæ¥è¯´è¯´ã€‚ä¸€ä¸ªæ˜¯åˆ›å»º Bean å®ä¾‹çš„ createBeanInstance æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä¾èµ–æ³¨å…¥çš„ populateBean æ–¹æ³•ï¼Œè¿˜æœ‰å°±æ˜¯å›è°ƒæ–¹æ³• initializeBeanã€‚ </p>
<p>æ³¨æ„äº†ï¼Œæ¥ä¸‹æ¥çš„è¿™ä¸‰ä¸ªæ–¹æ³•è¦è®¤çœŸè¯´é‚£ä¹Ÿæ˜¯æå…¶å¤æ‚çš„ï¼Œå¾ˆå¤šåœ°æ–¹æˆ‘å°±ç‚¹åˆ°ä¸ºæ­¢äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±å¾€é‡Œçœ‹ï¼Œæœ€å¥½å°±æ˜¯ç¢°åˆ°ä¸æ‡‚çš„ï¼Œè‡ªå·±å†™ä»£ç å»è°ƒè¯•å®ƒã€‚</p>
<h5 id="åˆ›å»º-Bean-å®ä¾‹"><a href="#åˆ›å»º-Bean-å®ä¾‹" class="headerlink" title="åˆ›å»º Bean å®ä¾‹"></a>åˆ›å»º Bean å®ä¾‹</h5><p>æˆ‘ä»¬å…ˆçœ‹çœ‹ createBeanInstance æ–¹æ³•ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¦‚æœæ¯ä¸ªåˆ†æ”¯éƒ½åˆ†æä¸‹å»ï¼Œå¿…ç„¶ä¹Ÿæ˜¯æå…¶å¤æ‚å†—é•¿çš„ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹è¯´ã€‚æ­¤æ–¹æ³•çš„ç›®çš„å°±æ˜¯å®ä¾‹åŒ–æˆ‘ä»¬æŒ‡å®šçš„ç±»ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ç¡®ä¿å·²ç»åŠ è½½äº†æ­¤ class</span>
   <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// æ ¡éªŒä¸€ä¸‹è¿™ä¸ªç±»çš„è®¿é—®æƒé™</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
            <span class="token string">"Bean class isn't public, and non-public access not allowed: "</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
      <span class="token comment">// é‡‡ç”¨å·¥å‚æ–¹æ³•å®ä¾‹åŒ–ï¼Œä¸ç†Ÿæ‚‰è¿™ä¸ªæ¦‚å¿µçš„è¯»è€…è¯·çœ‹é™„å½•ï¼Œæ³¨æ„ï¼Œä¸æ˜¯ FactoryBean</span>
      <span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œæ¯”å¦‚ç¬¬äºŒæ¬¡åˆ›å»º prototype beanã€‚</span>
   <span class="token comment">// è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ç¬¬ä¸€æ¬¡åˆ›å»ºçŸ¥é“ï¼Œé‡‡ç”¨æ— å‚æ„é€ å‡½æ•°ï¼Œè¿˜æ˜¯æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥ æ¥å®Œæˆå®ä¾‹åŒ–</span>
   <span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
         <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// æ— å‚æ„é€ å‡½æ•°</span>
         <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ¤æ–­æ˜¯å¦é‡‡ç”¨æœ‰å‚æ„é€ å‡½æ•°</span>
   <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>AUTOWIRE_CONSTRUCTOR <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
      <span class="token comment">// æ„é€ å‡½æ•°ä¾èµ–æ³¨å…¥</span>
      <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// è°ƒç”¨æ— å‚æ„é€ å‡½æ•°</span>
   <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æŒ‘ä¸ªç®€å•çš„<strong>æ— å‚æ„é€ å‡½æ•°</strong>æ„é€ å®ä¾‹æ¥çœ‹çœ‹ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> beanInstance<span class="token punctuation">;</span>
      <span class="token keyword">final</span> <span class="token class-name">BeanFactory</span> parent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         beanInstance <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               
               <span class="token keyword">return</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// å®ä¾‹åŒ–</span>
         beanInstance <span class="token operator">=</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åŒ…è£…ä¸€ä¸‹ï¼Œè¿”å›</span>
      <span class="token class-name">BeanWrapper</span> bw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanWrapperImpl</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">initBeanWrapper</span><span class="token punctuation">(</span>bw<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> bw<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…³é”®çš„åœ°æ–¹åœ¨äºï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">beanInstance <span class="token operator">=</span> <span class="token function">getInstantiationStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">instantiate</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å®ä¾‹åŒ–è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹:</p>
<p>// SimpleInstantiationStrategy 59</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token comment">// å¦‚æœä¸å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œé‚£å°±ä½¿ç”¨ java åå°„è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¦åˆ™ä½¿ç”¨ CGLIB,</span>
   <span class="token comment">// æ–¹æ³•è¦†å†™ è¯·å‚è§é™„å½•"æ–¹æ³•æ³¨å…¥"ä¸­å¯¹ lookup-method å’Œ replaced-method çš„ä»‹ç»</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructorToUse<span class="token punctuation">;</span>
      <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>bd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         constructorToUse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod<span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>constructorToUse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"Specified class is an interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  constructorToUse <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Constructor</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token annotation punctuation">@Override</span>
                     <span class="token keyword">public</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">else</span> <span class="token punctuation">{</span>
                  constructorToUse <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               bd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">=</span> constructorToUse<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInstantiationException</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token string">"No default constructor found"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åˆ©ç”¨æ„é€ æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–</span>
      <span class="token keyword">return</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>constructorToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å­˜åœ¨æ–¹æ³•è¦†å†™ï¼Œåˆ©ç”¨ CGLIB æ¥å®Œæˆå®ä¾‹åŒ–ï¼Œéœ€è¦ä¾èµ–äº CGLIB ç”Ÿæˆå­ç±»ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</span>
      <span class="token comment">// tips: å› ä¸ºå¦‚æœä¸ä½¿ç”¨ CGLIB çš„è¯ï¼Œå­˜åœ¨ override çš„æƒ…å†µ JDK å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„å®ä¾‹åŒ–æ”¯æŒ</span>
      <span class="token keyword">return</span> <span class="token function">instantiateWithMethodInjection</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ç®—å®ä¾‹åŒ–å®Œæˆäº†ã€‚æˆ‘ä»¬å¼€å§‹è¯´æ€ä¹ˆè¿›è¡Œå±æ€§æ³¨å…¥ã€‚</p>
<h5 id="bean-å±æ€§æ³¨å…¥"><a href="#bean-å±æ€§æ³¨å…¥" class="headerlink" title="bean å±æ€§æ³¨å…¥"></a>bean å±æ€§æ³¨å…¥</h5><p>çœ‹å®Œäº† createBeanInstance(â€¦) æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ populateBean(â€¦) æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£è¿›è¡Œå±æ€§è®¾å€¼ï¼Œå¤„ç†ä¾èµ–ã€‚</p>
<p>// AbstractAutowireCapableBeanFactory 1203</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// bean å®ä¾‹çš„æ‰€æœ‰å±æ€§éƒ½åœ¨è¿™é‡Œäº†</span>
   <span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pvs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
               mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Cannot apply property values to null instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// Skip property population phase for null instance.</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// åˆ°è¿™æ­¥çš„æ—¶å€™ï¼Œbean å®ä¾‹åŒ–å®Œæˆï¼ˆé€šè¿‡å·¥å‚æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ï¼‰ï¼Œä½†æ˜¯è¿˜æ²¡å¼€å§‹å±æ€§è®¾å€¼ï¼Œ</span>
   <span class="token comment">// InstantiationAwareBeanPostProcessor çš„å®ç°ç±»å¯ä»¥åœ¨è¿™é‡Œå¯¹ bean è¿›è¡ŒçŠ¶æ€ä¿®æ”¹ï¼Œ</span>
   <span class="token comment">// æˆ‘ä¹Ÿæ²¡æ‰¾åˆ°æœ‰å®é™…çš„ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬æš‚ä¸”å¿½ç•¥è¿™å—å§</span>
   <span class="token keyword">boolean</span> continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
            <span class="token comment">// å¦‚æœè¿”å› falseï¼Œä»£è¡¨ä¸éœ€è¦è¿›è¡Œåç»­çš„å±æ€§è®¾å€¼ï¼Œä¹Ÿä¸éœ€è¦å†ç»è¿‡å…¶ä»–çš„ BeanPostProcessor çš„å¤„ç†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>continueWithPropertyPopulation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>AUTOWIRE_BY_NAME <span class="token operator">||</span>
         mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>AUTOWIRE_BY_TYPE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">MutablePropertyValues</span> newPvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// é€šè¿‡åå­—æ‰¾åˆ°æ‰€æœ‰å±æ€§å€¼ï¼Œå¦‚æœæ˜¯ bean ä¾èµ–ï¼Œå…ˆåˆå§‹åŒ–ä¾èµ–çš„ beanã€‚è®°å½•ä¾èµ–å…³ç³»</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>AUTOWIRE_BY_NAME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">autowireByName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// é€šè¿‡ç±»å‹è£…é…ã€‚å¤æ‚ä¸€äº›</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>AUTOWIRE_BY_TYPE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">autowireByType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      pvs <span class="token operator">=</span> newPvs<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span>DEPENDENCY_CHECK_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps <span class="token operator">||</span> needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
               <span class="token comment">// è¿™é‡Œæœ‰ä¸ªéå¸¸æœ‰ç”¨çš„ BeanPostProcessor è¿›åˆ°è¿™é‡Œ: AutowiredAnnotationBeanPostProcessor</span>
               <span class="token comment">// å¯¹é‡‡ç”¨ @Autowiredã€@Value æ³¨è§£çš„ä¾èµ–è¿›è¡Œè®¾å€¼ï¼Œè¿™é‡Œçš„å†…å®¹ä¹Ÿæ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œä¸è¿‡æœ¬æ–‡ä¸ä¼šå±•å¼€è¯´äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…è¯·è‡ªè¡Œç ”ç©¶</span>
               pvs <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// è®¾ç½® bean å®ä¾‹çš„å±æ€§å€¼</span>
   <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="initializeBean"><a href="#initializeBean" class="headerlink" title="initializeBean"></a>initializeBean</h5><p>å±æ€§æ³¨å…¥å®Œæˆåï¼Œè¿™ä¸€æ­¥å…¶å®å°±æ˜¯å¤„ç†å„ç§å›è°ƒäº†ï¼Œè¿™å—ä»£ç æ¯”è¾ƒç®€å•ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token annotation punctuation">@Override</span>
         <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœ bean å®ç°äº† BeanNameAwareã€BeanClassLoaderAware æˆ– BeanFactoryAware æ¥å£ï¼Œå›è°ƒ</span>
      <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token class-name">Object</span> wrappedBean <span class="token operator">=</span> bean<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// BeanPostProcessor çš„ postProcessBeforeInitialization å›è°ƒ</span>
      wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¤„ç† bean ä¸­å®šä¹‰çš„ init-methodï¼Œ</span>
      <span class="token comment">// æˆ–è€…å¦‚æœ bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet() æ–¹æ³•</span>
      <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            beanName<span class="token punctuation">,</span> <span class="token string">"Invocation of init method failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// BeanPostProcessor çš„ postProcessAfterInitialization å›è°ƒ</span>
      wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¤§å®¶å‘ç°æ²¡æœ‰ï¼ŒBeanPostProcessor çš„ä¸¤ä¸ªå›è°ƒéƒ½å‘ç”Ÿåœ¨è¿™è¾¹ï¼Œåªä¸è¿‡ä¸­é—´å¤„ç†äº† init-methodï¼Œæ˜¯ä¸æ˜¯å’Œè¯»è€…åŸæ¥çš„è®¤çŸ¥æœ‰ç‚¹ä¸ä¸€æ ·äº†ï¼Ÿ</p>
<h2 id="4-é™„å½•"><a href="#4-é™„å½•" class="headerlink" title="4. é™„å½•"></a>4. é™„å½•</h2><h3 id="â‘ -id-å’Œ-name"><a href="#â‘ -id-å’Œ-name" class="headerlink" title="â‘  id å’Œ name"></a>â‘  id å’Œ name</h3><p>æ¯ä¸ª Bean åœ¨ Spring å®¹å™¨ä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼ˆbeanNameï¼‰å’Œ 0 ä¸ªæˆ–å¤šä¸ªåˆ«åï¼ˆaliasesï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä» Spring å®¹å™¨ä¸­è·å– Bean çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ® beanNameï¼Œä¹Ÿå¯ä»¥é€šè¿‡åˆ«åã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">"beanName or alias"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨é…ç½® <code>&lt;bean /&gt;</code> çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® id å’Œ nameï¼Œçœ‹å‡ ä¸ªä¾‹å­å°±çŸ¥é“æ˜¯æ€ä¹ˆå›äº‹äº†ã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messageService<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>m1, m2, m3<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œåˆ«åæœ‰ 3 ä¸ªï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>m1, m2, m3<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º m1ï¼Œåˆ«åæœ‰ 2 ä¸ªï¼Œåˆ†åˆ«ä¸º m2ã€m3ã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>beanName ä¸ºï¼šcom.javadoop.example.MessageServiceImpl#0ï¼Œ</p>
<p>åˆ«å 1 ä¸ªï¼Œä¸ºï¼š com.javadoop.example.MessageServiceImpl</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>messageService<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.example.MessageServiceImpl<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä»¥ä¸Šé…ç½®çš„ç»“æœå°±æ˜¯ï¼šbeanName ä¸º messageServiceï¼Œæ²¡æœ‰åˆ«åã€‚</p>
<h3 id="â‘¡-é…ç½®æ˜¯å¦å…è®¸-Bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–"><a href="#â‘¡-é…ç½®æ˜¯å¦å…è®¸-Bean-è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–" class="headerlink" title="â‘¡ é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–"></a>â‘¡ é…ç½®æ˜¯å¦å…è®¸ Bean è¦†ç›–ã€æ˜¯å¦å…è®¸å¾ªç¯ä¾èµ–</h3><p>æˆ‘ä»¬è¯´è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒallowBeanDefinitionOverriding å±æ€§ä¸º nullã€‚å¦‚æœåœ¨åŒä¸€é…ç½®æ–‡ä»¶ä¸­ Bean id æˆ– name é‡å¤äº†ï¼Œä¼šæŠ›é”™ï¼Œä½†æ˜¯å¦‚æœä¸æ˜¯åŒä¸€é…ç½®æ–‡ä»¶ä¸­ï¼Œä¼šå‘ç”Ÿè¦†ç›–ã€‚</p>
<p>å¯æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å°±ä¸¥æ ¼æœç»å‘ç”Ÿ Bean è¦†ç›–ï¼Œå› ä¸ºä¸‡ä¸€å‡ºç°è¿™ç§æƒ…å†µï¼Œä¼šå¢åŠ æˆ‘ä»¬æ’æŸ¥é—®é¢˜çš„æˆæœ¬ã€‚</p>
<p>å¾ªç¯ä¾èµ–è¯´çš„æ˜¯ A ä¾èµ– Bï¼Œè€Œ B åˆä¾èµ– Aã€‚æˆ–è€…æ˜¯ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œè€Œ C å´ä¾èµ– Aã€‚é»˜è®¤ allowCircularReferences ä¹Ÿæ˜¯ nullã€‚</p>
<p>å®ƒä»¬ä¸¤ä¸ªå±æ€§æ˜¯ä¸€èµ·å‡ºç°çš„ï¼Œå¿…ç„¶å¯ä»¥åœ¨åŒä¸€ä¸ªåœ°æ–¹ä¸€èµ·è¿›è¡Œé…ç½®ã€‚</p>
<p>æ·»åŠ è¿™ä¸¤ä¸ªå±æ€§çš„ä½œè€… Juergen Hoeller åœ¨è¿™ä¸ª <a target="_blank" rel="noopener" href="https://jira.spring.io/browse/SPR-4374">jira</a> çš„è®¨è®ºä¸­è¯´æ˜äº†æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªå±æ€§ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NoBeanOverridingContextLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ContextLoader</span> <span class="token punctuation">{</span>
 
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">customizeContext</span><span class="token punctuation">(</span><span class="token class-name">ServletContext</span> servletContext<span class="token punctuation">,</span> <span class="token class-name">ConfigurableWebApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">customizeContext</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">,</span> applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AbstractRefreshableApplicationContext</span> arac <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractRefreshableApplicationContext</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">;</span>
    arac<span class="token punctuation">.</span><span class="token function">setAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyContextLoaderListener</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>ContextLoaderListener</span> <span class="token punctuation">{</span>
 
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token class-name">ContextLoader</span> <span class="token function">createContextLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NoBeanOverridingContextLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">&gt;</span></span>com.javadoop.MyContextLoaderListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener-class</span><span class="token punctuation">&gt;</span></span>  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœä»¥ä¸Šæ–¹å¼ä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œè¯·å‚è€ƒè¿™ä¸ªé“¾æ¥ï¼š<a target="_blank" rel="noopener" href="http://blog.csdn.net/zgmzyr/article/details/39380477">è§£å†³springä¸­ä¸åŒé…ç½®æ–‡ä»¶ä¸­å­˜åœ¨nameæˆ–è€…idç›¸åŒçš„beanå¯èƒ½å¼•èµ·çš„é—®é¢˜</a></p>
<h3 id="â‘¢-profile"><a href="#â‘¢-profile" class="headerlink" title="â‘¢ profile"></a>â‘¢ profile</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠä¸åŒç¯å¢ƒçš„é…ç½®åˆ†åˆ«é…ç½®åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/jdbc<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>embedded-database</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:com/bank/config/sql/schema.sql<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:com/bank/config/sql/test-data.sql<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">jdbc:</span>embedded-database</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>production<span class="token punctuation">"</span></span>
    <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/jee<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jee:</span>jndi-lookup</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">jndi-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java:comp/env/jdbc/datasource<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åº”è¯¥ä¸å¿…åšè¿‡å¤šè§£é‡Šäº†å§ï¼Œçœ‹æ¯ä¸ªæ–‡ä»¶ç¬¬ä¸€è¡Œçš„ profile=â€â€ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jdbc</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/jdbc<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>jee</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/jee<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>...<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>development<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>embedded-database</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:com/bank/config/sql/schema.sql<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jdbc:</span>script</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:com/bank/config/sql/test-data.sql<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">jdbc:</span>embedded-database</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">profile</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>production<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">jee:</span>jndi-lookup</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">jndi-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java:comp/env/jdbc/datasource<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•å§ã€‚</p>
<p>æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæ€ä¹ˆä½¿ç”¨ç‰¹å®šçš„ profile å‘¢ï¼ŸSpring åœ¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå»å¯»æ‰¾ â€œspring.profiles.activeâ€ çš„å±æ€§å€¼ï¼Œæ ¹æ®è¿™ä¸ªå±æ€§å€¼æ¥çš„ã€‚é‚£æ€ä¹ˆé…ç½®è¿™ä¸ªå€¼å‘¢ï¼Ÿ</p>
<p>Spring ä¼šåœ¨è¿™å‡ ä¸ªåœ°æ–¹å¯»æ‰¾ spring.profiles.active çš„å±æ€§å€¼ï¼šæ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ã€JVM ç³»ç»Ÿå˜é‡ã€web.xml ä¸­å®šä¹‰çš„å‚æ•°ã€JNDIã€‚</p>
<p>æœ€ç®€å•çš„æ–¹å¼è«è¿‡äºåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™æŒ‡å®šï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-Dspring.profiles.active<span class="token operator">=</span><span class="token string">"profile1,profile2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>profile å¯ä»¥æ¿€æ´»å¤šä¸ª</p>
</blockquote>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç çš„å½¢å¼ä» Environment ä¸­è®¾ç½® profileï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">AnnotationConfigApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setActiveProfiles</span><span class="token punctuation">(</span><span class="token string">"development"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">SomeConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">StandaloneDataConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">JndiDataConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ctx<span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é‡å¯</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæ˜¯ Spring Boot çš„è¯æ›´ç®€å•ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šåˆ›å»º application.propertiesã€application-dev.propertiesã€application-prod.properties ç­‰æ–‡ä»¶ï¼Œå…¶ä¸­ application.properties é…ç½®å„ä¸ªç¯å¢ƒé€šç”¨çš„é…ç½®ï¼Œapplication-{profile}.properties ä¸­é…ç½®ç‰¹å®šç¯å¢ƒçš„é…ç½®ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®š profileï¼š</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">java -Dspring.profiles.active<span class="token operator">=</span>prod -jar JavaDoop.jar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>å¦‚æœæ˜¯å•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„è¯ï¼Œåœ¨æµ‹è¯•ç±»ä¸­ä½¿ç”¨ @ActiveProfiles æŒ‡å®šï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
<h3 id="â‘£-å·¥å‚æ¨¡å¼ç”Ÿæˆ-Bean"><a href="#â‘£-å·¥å‚æ¨¡å¼ç”Ÿæˆ-Bean" class="headerlink" title="â‘£ å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean"></a>â‘£ å·¥å‚æ¨¡å¼ç”Ÿæˆ Bean</h3><p>è¯·è¯»è€…æ³¨æ„ factory-bean å’Œ FactoryBean çš„åŒºåˆ«ã€‚è¿™èŠ‚è¯´çš„æ˜¯å‰è€…ï¼Œæ˜¯è¯´é™æ€å·¥å‚æˆ–å®ä¾‹å·¥å‚ï¼Œè€Œåè€…æ˜¯ Spring ä¸­çš„ç‰¹æ®Šæ¥å£ï¼Œä»£è¡¨ä¸€ç±»ç‰¹æ®Šçš„ Beanï¼Œé™„å½•çš„ä¸‹é¢ä¸€èŠ‚ä¼šä»‹ç» FactoryBeanã€‚</p>
<p>è®¾è®¡æ¨¡å¼é‡Œï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼åˆ†é™æ€å·¥å‚å’Œå®ä¾‹å·¥å‚ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹ Spring ä¸­æ€ä¹ˆé…ç½®è¿™ä¸¤ä¸ªï¼Œæ¥ä¸ªä»£ç ç¤ºä¾‹å°±ä»€ä¹ˆéƒ½æ¸…æ¥šäº†ã€‚</p>
<p>é™æ€å·¥å‚ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clientService<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>examples.ClientService<span class="token punctuation">"</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createInstance<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClientService</span> clientService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ClientService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">// é™æ€æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClientService</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> clientService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å®ä¾‹å·¥å‚ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>serviceLocator<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>examples.DefaultServiceLocator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject any dependencies required by this locator bean --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>clientService<span class="token punctuation">"</span></span>
    <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>serviceLocator<span class="token punctuation">"</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createClientServiceInstance<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>accountService<span class="token punctuation">"</span></span>
    <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>serviceLocator<span class="token punctuation">"</span></span>
    <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createAccountServiceInstance<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultServiceLocator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClientService</span> clientService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AccountService</span> accountService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ClientService</span> <span class="token function">createClientServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> clientService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AccountService</span> <span class="token function">createAccountServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> accountService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="â‘¤-FactoryBean"><a href="#â‘¤-FactoryBean" class="headerlink" title="â‘¤ FactoryBean"></a>â‘¤ FactoryBean</h3><p>FactoryBean é€‚ç”¨äº Bean çš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥æ± çš„åˆ›å»ºã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span> 
    <span class="token keyword">private</span> <span class="token class-name">Car</span> car <span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setCar</span><span class="token punctuation">(</span><span class="token class-name">Car</span> car<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>car <span class="token operator">=</span> car<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬å‡è®¾ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ª Person çš„ Beanï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Car çš„å®ä¾‹ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾ Car çš„å®ä¾‹åˆ›å»ºå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠåˆ›å»º Car çš„å¤æ‚è¿‡ç¨‹åŒ…è£…èµ·æ¥ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCarFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Car</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> make<span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token keyword">int</span> year <span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMake</span><span class="token punctuation">(</span><span class="token class-name">String</span> m<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>make <span class="token operator">=</span>m <span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setYear</span><span class="token punctuation">(</span><span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>year <span class="token operator">=</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Car</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token comment">// è¿™é‡Œæˆ‘ä»¬å‡è®¾ Car çš„å®ä¾‹åŒ–è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåæ­£å°±ä¸æ˜¯å‡ è¡Œä»£ç å¯ä»¥å†™å®Œçš„é‚£ç§</span>
      <span class="token class-name">CarBuilder</span> cb <span class="token operator">=</span> <span class="token class-name">CarBuilder</span><span class="token punctuation">.</span><span class="token function">car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span> cb<span class="token punctuation">.</span><span class="token function">setYear</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>make<span class="token punctuation">)</span><span class="token punctuation">)</span> cb<span class="token punctuation">.</span><span class="token function">setMake</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>make <span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token keyword">return</span> cb<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Car</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token class-name">Car</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">;</span> <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬çœ‹çœ‹è£…é…çš„æ—¶å€™æ˜¯æ€ä¹ˆé…ç½®çš„ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>com.javadoop.MyCarFactoryBean<span class="token punctuation">"</span></span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>car<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>make<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Honda<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>year<span class="token punctuation">"</span></span> <span class="token attr-name">value</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1984<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>com.javadoop.Person<span class="token punctuation">"</span></span> <span class="token attr-name">id</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>josh<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>car<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span> <span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">"</span>car<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹åˆ°ä¸ä¸€æ ·äº†å—ï¼Ÿid ä¸º â€œcarâ€ çš„ bean å…¶å®æŒ‡å®šçš„æ˜¯ä¸€ä¸ª FactoryBeanï¼Œä¸è¿‡é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥è®©é…ç½® Person çš„ Bean ç›´æ¥ä¾èµ–äºè¿™ä¸ª FactoryBean å°±å¯ä»¥äº†ã€‚ä¸­é—´çš„è¿‡ç¨‹ Spring å·²ç»å°è£…å¥½äº†ã€‚</p>
<p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†æ¥ç‚¹å¹²è´§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç°åœ¨è¿˜ç”¨ xml é…ç½® Bean ä¾èµ–çš„è¶Šæ¥è¶Šå°‘äº†ï¼Œæ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡‡ç”¨ java  config çš„æ–¹å¼æ¥é…ç½®ï¼Œè¿™é‡Œæœ‰ä»€ä¹ˆä¸ä¸€æ ·å‘¢ï¼Ÿ</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CarConfiguration</span> <span class="token punctuation">{</span> 

    <span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> <span class="token class-name">MyCarFactoryBean</span> <span class="token function">carFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
      <span class="token class-name">MyCarFactoryBean</span> cfb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCarFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cfb<span class="token punctuation">.</span><span class="token function">setMake</span><span class="token punctuation">(</span><span class="token string">"Honda"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      cfb<span class="token punctuation">.</span><span class="token function">setYear</span><span class="token punctuation">(</span><span class="token number">1984</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cfb<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">aPerson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token class-name">Person</span> person <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// æ³¨æ„è¿™é‡Œçš„ä¸åŒ</span>
    person<span class="token punctuation">.</span><span class="token function">setCar</span><span class="token punctuation">(</span><span class="token function">carFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> person<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æˆ‘ä»¬çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠ MyCarFactoryBean çœ‹æˆæ˜¯ä¸€ä¸ªç®€å•çš„ Bean å°±å¯ä»¥äº†ï¼Œä¸å¿…ç†ä¼šä»€ä¹ˆ FactoryBeanï¼Œå®ƒæ˜¯ä¸æ˜¯ FactoryBean å’Œæˆ‘ä»¬æ²¡å…³ç³»ã€‚</p>
<h3 id="â‘¥-åˆå§‹åŒ–-Bean-çš„å›è°ƒ"><a href="#â‘¥-åˆå§‹åŒ–-Bean-çš„å›è°ƒ" class="headerlink" title="â‘¥ åˆå§‹åŒ– Bean çš„å›è°ƒ"></a>â‘¥ åˆå§‹åŒ– Bean çš„å›è°ƒ</h3><p>æœ‰ä»¥ä¸‹å››ç§æ–¹æ¡ˆï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleInitBean<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>examples.ExampleBean<span class="token punctuation">"</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnotherExampleBean</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do some initialization work</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>initMethod <span class="token operator">=</span> <span class="token string">"init"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Foo</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="â‘¦-é”€æ¯-Bean-çš„å›è°ƒ"><a href="#â‘¦-é”€æ¯-Bean-çš„å›è°ƒ" class="headerlink" title="â‘¦ é”€æ¯ Bean çš„å›è°ƒ"></a>â‘¦ é”€æ¯ Bean çš„å›è°ƒ</h3><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>exampleInitBean<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>examples.ExampleBean<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cleanup<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnotherExampleBean</span> <span class="token keyword">implements</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do some destruction work (like releasing pooled connections)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>destroyMethod <span class="token operator">=</span> <span class="token string">"cleanup"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Bar</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@PreDestroy</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="â‘§-ConversionService"><a href="#â‘§-ConversionService" class="headerlink" title="â‘§ ConversionService"></a>â‘§ ConversionService</h3><p>æ—¢ç„¶æ–‡ä¸­è¯´åˆ°äº†è¿™ä¸ªï¼Œé¡ºä¾¿æä¸€ä¸‹å¥½äº†ã€‚</p>
<p>æœ€æœ‰ç”¨çš„åœºæ™¯å°±æ˜¯ï¼Œå®ƒç”¨æ¥å°†å‰ç«¯ä¼ è¿‡æ¥çš„å‚æ•°å’Œåç«¯çš„ controller æ–¹æ³•ä¸Šçš„å‚æ•°è¿›è¡Œç»‘å®šçš„æ—¶å€™ç”¨ã€‚</p>
<p>åƒå‰ç«¯ä¼ è¿‡æ¥çš„å­—ç¬¦ä¸²ã€æ•´æ•°è¦è½¬æ¢ä¸ºåç«¯çš„ Stringã€Integer å¾ˆå®¹æ˜“ï¼Œä½†æ˜¯å¦‚æœ controller æ–¹æ³•éœ€è¦çš„æ˜¯ä¸€ä¸ªæšä¸¾å€¼ï¼Œæˆ–è€…æ˜¯ Date è¿™äº›éåŸºç¡€ç±»å‹ï¼ˆå«åŸºç¡€ç±»å‹åŒ…è£…ç±»ï¼‰å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘é‡‡ç”¨ ConversionService æ¥è¿›è¡Œè½¬æ¢ã€‚</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>conversionService<span class="token punctuation">"</span></span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.context.support.ConversionServiceFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>converters<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.javadoop.learning.utils.StringToEnumConverterFactory<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ConversionService æ¥å£å¾ˆç®€å•ï¼Œæ‰€ä»¥è¦è‡ªå®šä¹‰ä¸€ä¸ª convert çš„è¯ä¹Ÿå¾ˆç®€å•ã€‚</p>
<p>ä¸‹é¢å†è¯´ä¸€ä¸ªå®ç°è¿™ç§è½¬æ¢å¾ˆç®€å•çš„æ–¹å¼ï¼Œé‚£å°±æ˜¯å®ç° Converter æ¥å£ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œè¿™æ ·æ¯”ä»€ä¹ˆéƒ½ç®¡ç”¨ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringToDateConverter</span> <span class="token keyword">implements</span> <span class="token class-name">Converter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Date</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Date</span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">DateUtils</span><span class="token punctuation">.</span><span class="token function">parseDate</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd HH:mm"</span><span class="token punctuation">,</span> <span class="token string">"HH:mm:ss"</span><span class="token punctuation">,</span> <span class="token string">"HH:mm"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åªè¦æ³¨å†Œè¿™ä¸ª Bean å°±å¯ä»¥äº†ã€‚è¿™æ ·ï¼Œå‰ç«¯å¾€åç«¯ä¼ çš„æ—¶é—´æè¿°å­—ç¬¦ä¸²å°±å¾ˆå®¹æ˜“ç»‘å®šæˆ Date ç±»å‹äº†ï¼Œä¸éœ€è¦å…¶ä»–ä»»ä½•æ“ä½œã€‚</p>
<h3 id="â‘¨-Bean-ç»§æ‰¿"><a href="#â‘¨-Bean-ç»§æ‰¿" class="headerlink" title="â‘¨ Bean ç»§æ‰¿"></a>â‘¨ Bean ç»§æ‰¿</h3><p>åœ¨åˆå§‹åŒ– Bean çš„åœ°æ–¹ï¼Œæˆ‘ä»¬è¯´è¿‡äº†è¿™ä¸ªï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>è¿™é‡Œæ¶‰åŠåˆ°çš„å°±æ˜¯ <code>&lt;bean parent="" /&gt;</code> ä¸­çš„ parent å±æ€§ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ Spring ä¸­æ˜¯ç”¨è¿™ä¸ªæ¥å¹²ä»€ä¹ˆçš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œè¿™é‡Œçš„ç»§æ‰¿å’Œ java è¯­æ³•ä¸­çš„ç»§æ‰¿æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿‡æ€è·¯æ˜¯ç›¸é€šçš„ã€‚child bean ä¼šç»§æ‰¿ parent bean çš„æ‰€æœ‰é…ç½®ï¼Œä¹Ÿå¯ä»¥è¦†ç›–ä¸€äº›é…ç½®ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ–°å¢é¢å¤–çš„é…ç½®ã€‚</p>
<p>Spring ä¸­æä¾›äº†ç»§æ‰¿è‡ª AbstractBeanDefinition çš„ <code>ChildBeanDefinition</code> æ¥è¡¨ç¤º child beanã€‚</p>
<p>çœ‹å¦‚ä¸‹ä¸€ä¸ªä¾‹å­:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"inheritedTestBean"</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token string">"true"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"org.springframework.beans.TestBean"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"name"</span> value<span class="token operator">=</span><span class="token string">"parent"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"age"</span> value<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"inheritsWithDifferentClass"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"org.springframework.beans.DerivedTestBean"</span>
        parent<span class="token operator">=</span><span class="token string">"inheritedTestBean"</span> init<span class="token operator">-</span>method<span class="token operator">=</span><span class="token string">"initialize"</span><span class="token operator">&gt;</span>
        
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"name"</span> value<span class="token operator">=</span><span class="token string">"override"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>parent bean è®¾ç½®äº† <code>abstract="true"</code> æ‰€ä»¥å®ƒä¸ä¼šè¢«å®ä¾‹åŒ–ï¼Œchild bean ç»§æ‰¿äº† parent bean çš„ä¸¤ä¸ªå±æ€§ï¼Œä½†æ˜¯å¯¹ name å±æ€§è¿›è¡Œäº†è¦†å†™ã€‚</p>
<p>child bean ä¼šç»§æ‰¿ scopeã€æ„é€ å™¨å‚æ•°å€¼ã€å±æ€§å€¼ã€init-methodã€destroy-method ç­‰ç­‰ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä¸æ˜¯è¯´ parent bean ä¸­çš„ abstract = true åœ¨è¿™é‡Œæ˜¯å¿…é¡»çš„ï¼Œåªæ˜¯è¯´å¦‚æœåŠ ä¸Šäº†ä»¥å Spring åœ¨å®ä¾‹åŒ– singleton beans çš„æ—¶å€™ä¼šå¿½ç•¥è¿™ä¸ª beanã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæç«¯ parent beanï¼Œå®ƒæ²¡æœ‰æŒ‡å®š classï¼Œæ‰€ä»¥æ¯«æ— ç–‘é—®ï¼Œè¿™ä¸ª bean çš„ä½œç”¨å°±æ˜¯ç”¨æ¥å……å½“æ¨¡æ¿ç”¨çš„ parent beanï¼Œæ­¤å¤„å°±å¿…é¡»åŠ ä¸Š abstract = trueã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">&lt;</span>bean id<span class="token operator">=</span><span class="token string">"inheritedTestBeanWithoutClass"</span> <span class="token keyword">abstract</span><span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"name"</span> value<span class="token operator">=</span><span class="token string">"parent"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>property name<span class="token operator">=</span><span class="token string">"age"</span> value<span class="token operator">=</span><span class="token string">"1"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>bean<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="â‘©-æ–¹æ³•æ³¨å…¥"><a href="#â‘©-æ–¹æ³•æ³¨å…¥" class="headerlink" title="â‘© æ–¹æ³•æ³¨å…¥"></a>â‘© æ–¹æ³•æ³¨å…¥</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„åº”ç”¨ä¸­å¤§å¤šæ•°çš„ Bean éƒ½æ˜¯ singleton çš„ã€‚singleton ä¾èµ– singletonï¼Œæˆ–è€… prototype ä¾èµ– prototype éƒ½å¾ˆå¥½è§£å†³ï¼Œç›´æ¥è®¾ç½®å±æ€§ä¾èµ–å°±å¯ä»¥äº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœæ˜¯ singleton ä¾èµ– prototype å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨å±æ€§ä¾èµ–ï¼Œå› ä¸ºå¦‚æœç”¨å±æ€§ä¾èµ–çš„è¯ï¼Œæˆ‘ä»¬æ¯æ¬¡å…¶å®æ‹¿åˆ°çš„è¿˜æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶å€™çš„ beanã€‚</p>
<p>ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸è¦ç”¨å±æ€§ä¾èµ–ï¼Œæ¯æ¬¡è·å–ä¾èµ–çš„ bean çš„æ—¶å€™ä» BeanFactory ä¸­å–ã€‚è¿™ä¸ªä¹Ÿæ˜¯å¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼äº†å§ã€‚æ€ä¹ˆå–ï¼Œæˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¤§éƒ¨åˆ† Spring é¡¹ç›®å¤§å®¶éƒ½ä¼šå®šä¹‰é‚£ä¹ˆä¸ªå·¥å…·ç±»çš„ã€‚</p>
<p>å¦ä¸€ç§è§£å†³æ–¹æ¡ˆå°±æ˜¯è¿™é‡Œè¦ä»‹ç»çš„é€šè¿‡ä½¿ç”¨ Lookup methodã€‚</p>
<h4 id="lookup-method"><a href="#lookup-method" class="headerlink" title="lookup-method"></a>lookup-method</h4><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ Spring Reference ä¸­æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">fiona<span class="token punctuation">.</span>apple</span><span class="token punctuation">;</span>

<span class="token comment">// no more Spring imports!</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// grab a new instance of the appropriate Command interface</span>
        <span class="token class-name">Command</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// set the state on the (hopefully brand new) Command instance</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// okay... but where is the implementation of this method?</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Command</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>xml é…ç½® <code>&lt;lookup-method /&gt;</code>ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token comment">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myCommand<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fiona.apple.AsyncCommand<span class="token punctuation">"</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>prototype<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- inject dependencies here as required --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>commandManager<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fiona.apple.CommandManager<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lookup-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createCommand<span class="token punctuation">"</span></span> <span class="token attr-name">bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myCommand<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Spring é‡‡ç”¨ <strong>CGLIB ç”Ÿæˆå­—èŠ‚ç </strong>çš„æ–¹å¼æ¥ç”Ÿæˆä¸€ä¸ªå­ç±»ã€‚æˆ‘ä»¬å®šä¹‰çš„ç±»ä¸èƒ½å®šä¹‰ä¸º final classï¼ŒæŠ½è±¡æ–¹æ³•ä¸Šä¹Ÿä¸èƒ½åŠ  finalã€‚</p>
<p>lookup-method ä¸Šçš„é…ç½®ä¹Ÿå¯ä»¥é‡‡ç”¨æ³¨è§£æ¥å®Œæˆï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨é…ç½® <code>&lt;lookup-method /&gt;</code> äº†ï¼Œå…¶ä»–ä¸å˜ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCommand</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Lookup</span><span class="token punctuation">(</span><span class="token string">"myCommand"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Command</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>æ³¨æ„ï¼Œæ—¢ç„¶ç”¨äº†æ³¨è§£ï¼Œè¦é…ç½®æ³¨è§£æ‰«æï¼š<code>&lt;context:component-scan base-package="com.javadoop" /&gt;</code></p>
</blockquote>
<p>ç”šè‡³ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">CommandManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">Object</span> commandState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCommand</span> command <span class="token operator">=</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        command<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>commandState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> command<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Lookup</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">MyCommand</span> <span class="token function">createCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>ä¸Šé¢çš„è¿”å›å€¼ç”¨äº† MyCommandï¼Œå½“ç„¶ï¼Œå¦‚æœ Command åªæœ‰ä¸€ä¸ªå®ç°ç±»ï¼Œé‚£è¿”å›å€¼ä¹Ÿå¯ä»¥å†™ Commandã€‚</p>
</blockquote>
<h4 id="replaced-method"><a href="#replaced-method" class="headerlink" title="replaced-method"></a>replaced-method</h4><p>è®°ä½å®ƒçš„åŠŸèƒ½ï¼Œå°±æ˜¯æ›¿æ¢æ‰ bean ä¸­çš„ä¸€äº›æ–¹æ³•ã€‚</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyValueCalculator</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">computeValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some real code...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// some other methods...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ–¹æ³•è¦†å†™ï¼Œæ³¨æ„è¦å®ç° MethodReplacer æ¥å£ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReplacementComputeValue</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>MethodReplacer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">reimplement</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> m<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// get the input value, work with it, and return a computed result</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é…ç½®ä¹Ÿå¾ˆç®€å•ï¼š</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>myValueCalculator<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>x.y.z.MyValueCalculator<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- å®šä¹‰ computeValue è¿™ä¸ªæ–¹æ³•è¦è¢«æ›¿æ¢æ‰ --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>replaced-method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>computeValue<span class="token punctuation">"</span></span> <span class="token attr-name">replacer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>replacementComputeValue<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg-type</span><span class="token punctuation">&gt;</span></span>String<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>arg-type</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>replaced-method</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>replacementComputeValue<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>a.b.c.ReplacementComputeValue<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>arg-type æ˜æ˜¾ä¸æ˜¯å¿…é¡»çš„ï¼Œé™¤éå­˜åœ¨æ–¹æ³•é‡è½½ï¼Œè¿™æ ·å¿…é¡»é€šè¿‡å‚æ•°ç±»å‹åˆ—è¡¨æ¥åˆ¤æ–­è¿™é‡Œè¦è¦†ç›–å“ªä¸ªæ–¹æ³•ã€‚</p>
</blockquote>
<h3 id="â‘ª-BeanPostProcessor"><a href="#â‘ª-BeanPostProcessor" class="headerlink" title="â‘ª BeanPostProcessor"></a>â‘ª BeanPostProcessor</h3><p>åº”è¯¥è¯´ BeanPostProcessor æ¦‚å¿µåœ¨ Spring ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰ï¼š</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanPostProcessor</span> <span class="token punctuation">{</span>

   <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

   <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>çœ‹è¿™ä¸ªæ¥å£ä¸­çš„ä¸¤ä¸ªæ–¹æ³•åå­—æˆ‘ä»¬å¤§ä½“ä¸Šå¯ä»¥çŒœæµ‹ bean åœ¨åˆå§‹åŒ–ä¹‹å‰ä¼šæ‰§è¡Œ postProcessBeforeInitialization è¿™ä¸ªæ–¹æ³•ï¼Œåˆå§‹åŒ–å®Œæˆä¹‹åä¼šæ‰§è¡Œ postProcessAfterInitialization è¿™ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆç†è§£æ˜¯éå¸¸ç‰‡é¢çš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½ï¼Œé™¤äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ BeanPostProcessor å®ç°å¤–ï¼ŒSpring å®¹å™¨åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨ç»™æˆ‘ä»¬ä¹ŸåŠ äº†å‡ ä¸ªã€‚å¦‚åœ¨è·å– BeanFactory çš„ obtainFactory() æ–¹æ³•ç»“æŸåçš„ prepareBeanFactory(factory)ï¼Œå¤§å®¶ä»”ç»†çœ‹ä¼šå‘ç°ï¼ŒSpring å¾€å®¹å™¨ä¸­æ·»åŠ äº†è¿™ä¸¤ä¸ª BeanPostProcessorï¼šApplicationContextAwareProcessorã€ApplicationListenerDetectorã€‚</p>
<p>æˆ‘ä»¬å›åˆ°è¿™ä¸ªæ¥å£æœ¬èº«ï¼Œè¯»è€…è¯·çœ‹ç¬¬ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ bean å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ bean çš„åå­—ï¼Œé‡ç‚¹åœ¨è¿”å›å€¼å°†ä¼šä½œä¸ºæ–°çš„ bean å®ä¾‹ï¼Œæ‰€ä»¥ï¼Œæ²¡äº‹çš„è¯è¿™é‡Œä¸èƒ½éšä¾¿è¿”å›ä¸ª nullã€‚</p>
<p>é‚£æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å¯¹ä¸€äº›æˆ‘ä»¬æƒ³è¦ä¿®é¥°çš„ bean å®ä¾‹åšä¸€äº›äº‹æƒ…ã€‚ä½†æ˜¯å¯¹äº Spring æ¡†æ¶æ¥è¯´ï¼Œå®ƒä¼šå†³å®šæ˜¯ä¸æ˜¯è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¿”å› bean å®ä¾‹çš„ä»£ç†ï¼Œè¿™æ ·å°±æœ‰æ›´å¤§çš„æƒ³è±¡ç©ºé—´äº†ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬è¯´è¯´å¦‚æœæˆ‘ä»¬è‡ªå·±å®šä¹‰ä¸€ä¸ª bean å®ç° BeanPostProcessor çš„è¯ï¼Œå®ƒçš„æ‰§è¡Œæ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ</p>
<p>å¦‚æœä»”ç»†çœ‹äº†ä»£ç åˆ†æçš„è¯ï¼Œå…¶å®å¾ˆå®¹æ˜“çŸ¥é“äº†ï¼Œåœ¨ bean å®ä¾‹åŒ–å®Œæˆã€å±æ€§æ³¨å…¥å®Œæˆä¹‹åï¼Œä¼šæ‰§è¡Œå›è°ƒæ–¹æ³•ï¼Œå…·ä½“è¯·å‚è§ç±» AbstractAutowireCapableBeanFactory#initBean æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆä¼šå›è°ƒå‡ ä¸ªå®ç°äº† Aware æ¥å£çš„ beanï¼Œç„¶åå°±å¼€å§‹å›è°ƒ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼Œä¹‹åæ˜¯å›è°ƒ init-methodï¼Œç„¶åå†å›è°ƒ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ã€‚</p>
<h2 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. æ€»ç»“</h2><p>æŒ‰ç†è¯´ï¼Œæ€»ç»“åº”è¯¥å†™åœ¨é™„å½•å‰é¢ï¼Œæˆ‘å°±ä¸è®²ç©¶äº†ã€‚</p>
<p>åœ¨èŠ±äº†é‚£ä¹ˆå¤šæ—¶é—´åï¼Œè¿™ç¯‡æ–‡ç« ç»ˆäºç®—æ˜¯åŸºæœ¬å†™å®Œäº†ï¼Œå¤§å®¶åœ¨æƒŠå¹ Spring ç»™æˆ‘ä»¬åšäº†é‚£ä¹ˆå¤šçš„äº‹çš„æ—¶å€™ï¼Œåº”è¯¥é€è¿‡ç°è±¡çœ‹æœ¬è´¨ï¼Œå»ç†è§£ Spring å†™å¾—å¥½çš„åœ°æ–¹ï¼Œå»ç†è§£å®ƒçš„è®¾è®¡æ€æƒ³ã€‚</p>
<p>æœ¬æ–‡çš„ç¼ºé™·åœ¨äºå¯¹ Spring é¢„åˆå§‹åŒ– singleton beans çš„è¿‡ç¨‹åˆ†æä¸å¤Ÿï¼Œä¸»è¦æ˜¯ä»£ç é‡çœŸçš„æ¯”è¾ƒå¤§ï¼Œåˆ†æ”¯æ—è·¯ä¼—å¤šã€‚åŒæ—¶ï¼Œè™½ç„¶é™„å½•æ¡ç›®ä¸å°‘ï¼Œä½†æ˜¯åºå¤§çš„ Spring çœŸçš„å¼•å‡ºäº†å¾ˆå¤šçš„æ¦‚å¿µï¼Œå¸Œæœ›æ—¥åæœ‰ç²¾åŠ›å¯ä»¥æ…¢æ…¢è¡¥å……ä¸€äº›ã€‚</p>
<p>ï¼ˆå…¨æ–‡å®Œï¼‰</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">å¸…æ«</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://kuangtf.github.io/2022/05/16/spring/2-springioc-rong-qi-yuan-ma-fen-xi/">https://kuangtf.github.io/2022/05/16/spring/2-springioc-rong-qi-yuan-ma-fen-xi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">å¸…æ«</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Spring-IoC/">
                                    <span class="chip bg-color">Spring IoC</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">å…ˆèµåçœ‹ï¼Œå…»æˆä¹ æƒ¯</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2022/05/16/spring/3-aop-xiang-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Spring AOP è¯¦è§£">
                        
                        <span class="card-title">Spring AOP è¯¦è§£</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-05-16
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring-AOP/">
                        <span class="chip bg-color">Spring AOP</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/05/16/spring/1-spring-jian-jie-ioc-xiang-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Spring ç®€ä»‹ + IoC è¯¦è§£">
                        
                        <span class="card-title">Spring ç®€ä»‹ + IoC è¯¦è§£</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring/" class="post-category">
                                    Spring
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring-IoC/">
                        <span class="chip bg-color">Spring IoC</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + 'æ¥æº: å¸…æ«<br />'
            + 'æ–‡ç« ä½œè€…: å¸…æ«<br />'
            + 'æ–‡ç« é“¾æ¥: <a href="' + url + '">' + url + '</a><br />'
            + 'æœ¬æ–‡ç« è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·æ³¨æ˜å‡ºå¤„ã€‚';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="kugou"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="sitetime"></span>
            <br>
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">å¸…æ«</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;ç«™ç‚¹æ€»å­—æ•°:&nbsp;<span
                class="white-color">603.5k</span>&nbsp;å­—
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;æ¬¡
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;äºº
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/kuangtf" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1162849426@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1162849426" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 1162849426" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/kuangtf" class="tooltipped" target="_blank" data-tooltip="å…³æ³¨æˆ‘çš„çŸ¥ä¹: https://www.zhihu.com/people/kuangtf" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">çŸ¥</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- è¿”å›dateå¯¹è±¡è·ä¸–ç•Œæ ‡å‡†æ—¶é—´(UTC)1970å¹´1æœˆ1æ—¥åˆå¤œä¹‹é—´çš„æ¯«ç§’æ•°(æ—¶é—´æˆ³)
        year - ä½œä¸ºdateå¯¹è±¡çš„å¹´ä»½ï¼Œä¸º4ä½å¹´ä»½å€¼
        month - 0-11ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æœˆä»½
        day - 1-31ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å¤©æ•°
        hours - 0(åˆå¤œ24ç‚¹)-23ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„å°æ—¶æ•°
        minutes - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„åˆ†é’Ÿæ•°
        seconds - 0-59ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„ç§’æ•°
        microseconds - 0-999ä¹‹é—´çš„æ•´æ•°ï¼Œåšä¸ºdateå¯¹è±¡çš„æ¯«ç§’æ•° */
        var t1 = Date.UTC(2021, 10, 01, 00, 00, 00); //åŒ—äº¬æ—¶é—´2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "æœ¬ç«™å·²è¿è¡Œ " +diffYears+" å¹´ "+diffDays + " å¤© " + diffHours + " å°æ—¶ " + diffMinutes + " åˆ†é’Ÿ " + diffSeconds + " ç§’";
    }/*å› ä¸ºå»ºç«™æ—¶é—´è¿˜æ²¡æœ‰ä¸€å¹´ï¼Œå°±å°†ä¹‹æ³¨é‡Šæ‰äº†ã€‚éœ€è¦çš„å¯ä»¥å–æ¶ˆ*/
    siteTime();
</script>

    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
